<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>RugbyBoard Pro â€” Bologna Rugby Club</title>
<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/umd/ffmpeg.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQODhPcO4/S/IpicFiGWcI4eXhF1G6h/ulD81Yj0L+O0BFCJAEInInKpTXy/x/YpB9PjS/fZy8f/K7t6h/a==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<style>
Â  :root{
Â  Â  --bg:#0b1520; --panel:#0e1c2a; --panel2:#122235; --ink:#e8eef5; --muted:#9fb3c8;
Â  Â  --border:#1b3147; --accent:#00c2ff; --accent2:#7ef29a; --warn:#ffd400; --red:#ff5a6b; --blue:#2f80ff;
Â  Â  --shadow:0 8px 28px rgba(0,0,0,.35);
Â  Â  --r:12px;
Â  }
Â  *{box-sizing:border-box}
Â  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
Â  .app{display:grid;grid-template-rows:auto 1fr;min-height:100dvh}

Â  /* Top bar */
Â  .topbar{display:flex;align-items:center;gap:12px;padding:10px 14px;background:linear-gradient(180deg,#0f2235,#0c1a29);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
Â  .brand{display:flex;align-items:center;gap:10px;font-weight:700}
Â  .brand .dot{width:12px;height:12px;border-radius:50%;background:var(--accent)}
Â  .toolbar{display:flex;gap:8px;margin-left:auto;flex-wrap:wrap}
Â  .btn{appearance:none;border:1px solid var(--border);background:#122538;color:var(--ink);padding:.55rem .8rem;border-radius:10px;cursor:pointer}
Â  .btn:disabled{opacity:.6;cursor:not-allowed}
Â  .btn.primary{background:#0f2a3f;border-color:#22445f}
Â  .seg{display:flex;border:1px solid var(--border);border-radius:10px;overflow:hidden}
Â  .seg button{border:none;background:#13293d;padding:.45rem .7rem;color:var(--ink);cursor:pointer}
Â  .seg button.active{background:#15354f;color:#7fe7ff}

Â  /* Stage */
Â  .stage{position:relative;display:grid;grid-template-columns: 1fr;grid-template-rows:1fr;min-height:100%; padding: 0;}
Â Â 
Â  .board-viewport{
Â  Â  position:relative;
Â  Â  inset:0;
Â  Â  display:flex;
Â  Â  justify-content: center;
Â  Â  align-items: center;
Â  Â  overflow:hidden;
Â  Â  width: 100%;
Â  Â  height: 100%;
Â  }
Â Â 
Â  .board-wrap{position:relative; width:1200px; height:700px; transform-origin:center center;}Â 
Â  .board{position:absolute;inset:0;background:#137a46;border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
Â  .lines, .draw{position:absolute;inset:0;pointer-events:none}
Â  svg{width:100%;height:100%;display:block}
Â  .grid{position:absolute;inset:0;pointer-events:none;opacity:.55;display:none}
Â  .grid.on{display:block}

Â  /* Players & ball */
Â  #players{position:absolute;inset:0;z-index:3;pointer-events:none}
Â  .player{pointer-events:auto;position:absolute;width:40px;height:40px;border-radius:50%;display:grid;place-items:center;font-weight:800;font-size:14px;color:#fff;border:2px solid #fff;box-shadow:0 4px 16px rgba(0,0,0,.3);cursor:grab}
Â  .player.selected{border: 3px solid var(--accent); box-shadow: 0 0 10px var(--accent);}
Â  .blue{background:var(--blue)} .red{background:var(--red)}
Â  .team-1{background:var(--blue);}
Â  .team-2{background:var(--red);}
Â Â 
Â  #ball{position:absolute;z-index:4}
Â  .ball{width:50px;height:30px;background:var(--warn);border:2px solid #fff;border-radius:50%/60%;transform:translate(-50%,-50%) rotate(-15deg);box-shadow:0 3px 12px rgba(0,0,0,.35);cursor:grab}
Â  .ball::after{content:"";position:absolute;inset:6px 18px;border-radius:50%/60%;border:2px dashed rgba(0,0,0,.25)}
Â Â 
Â  /* Selection Box */
Â  #selectionBox{
Â  Â  Â  position: absolute;
Â  Â  Â  pointer-events: none;
Â  Â  Â  border: 1px dashed var(--accent);
Â  Â  Â  background: rgba(0, 194, 255, 0.1);
Â  Â  Â  z-index: 5;
Â  Â  Â  display: none;
Â  }

Â  /* Modal Login */
Â  .modal-overlay {
Â  Â  position: fixed;
Â  Â  top: 0; left: 0; right: 0; bottom: 0;
Â  Â  background-color: rgba(0, 0, 0, 0.7);
Â  Â  display: none;
Â  Â  place-items: center;
Â  Â  z-index: 1000;
Â  }
Â  .modal-content {
Â  Â  background-color: var(--panel);
Â  Â  padding: 24px;
Â  Â  border-radius: 12px;
Â  Â  box-shadow: var(--shadow);
Â  Â  width: 90%;
Â  Â  max-width: 400px;
Â  Â  display: flex;
Â  Â  flex-direction: column;
Â  Â  gap: 15px;
Â  Â  border: 1px solid var(--border);
Â  }
Â  .modal-content input {
Â  Â  width: 100%;
Â  Â  padding: 10px;
Â  Â  background: var(--bg);
Â  Â  color: var(--ink);
Â  Â  border: 1px solid var(--border);
Â  Â  border-radius: 8px;
Â  }
Â  .modal-content button {
Â  Â  margin-top: 10px;
Â  }

Â  /* Desktop Styles */
Â  @media (min-width: 1000px){
Â  Â  .app{grid-template-rows:auto 1fr}
Â  Â  .stage{
Â  Â  Â  Â  grid-template-columns: 320px 1fr;
Â  Â  Â  Â  gap:14px;Â 
Â  Â  Â  Â  padding:12px;Â 
Â  Â  Â  Â  display: grid;Â 
Â  Â  Â  Â  min-height: calc(100dvh - 70px);Â 
Â  Â  }
Â  Â Â 
Â  Â  .sidepanel{
Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  background:var(--panel);
Â  Â  Â  Â  border:1px solid var(--border);
Â  Â  Â  Â  border-radius:12px;
Â  Â  Â  Â  padding:12px;
Â  Â  Â  Â  display:flex;Â 
Â  Â  Â  Â  flex-direction:column;
Â  Â  Â  Â  gap:12px;Â 
Â  Â  Â  Â  min-height: 100%;Â 
Â  Â  Â  Â  overflow-y: auto;Â 
Â  Â  Â  Â  transform: translateX(0) !important;
Â  Â  }
Â  Â Â 
Â  Â  .dock, #btnMenuOpen { display: none !important; }
Â  Â Â 
Â  Â  .sidepanel-section { padding-top: 0 !important; border-top: none !important; }
Â  Â  .sidepanel-section + .sidepanel-section { border-top: 1px solid var(--border) !important; padding-top: 12px !important; }
Â  }

Â  /* Mobile Styles */
Â  @media (max-width: 999px) {
Â  Â  .app {Â 
Â  Â  Â  Â  min-height: 100dvh;Â 
Â  Â  Â  Â  grid-template-rows: auto 1fr;Â 
Â  Â  }
Â  Â Â 
Â  Â  .stage {
Â  Â  Â  Â  padding: 0;Â 
Â  Â  Â  Â  min-height: auto;
Â  Â  Â  Â  height: 100%;Â 
Â  Â  }
Â  Â  .board-viewport {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  height: 100%;
Â  Â  }
Â  Â Â 
Â  Â  .topbar .seg, .topbar .toolbar > .btn { display: none; }
Â  Â  .topbar #btnAuthAction, .topbar #btnMenuOpen { display: flex; }

Â  Â  .sidepanel {
Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  bottom: 0;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  max-width: 100vw;
Â  Â  Â  Â  z-index: 1000;
Â  Â  Â  Â  background: var(--bg);
Â  Â  Â  Â  transform: translateX(-100%);
Â  Â  Â  Â  transition: transform 0.3s ease-out;
Â  Â  Â  Â  box-shadow: 4px 0 10px rgba(0,0,0,0.5);
Â  Â  Â  Â  padding-top: 60px;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column; /* Asegurar que el contenido fluya bien */
Â  Â  }
Â  Â Â 
Â  Â  .sidepanel.open {
Â  Â  Â  Â  transform: translateX(0);
Â  Â  }
Â  Â Â 
Â  Â  .dock { display: none !important; }
Â  Â Â 
Â  Â  #menuOverlay {
Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  right: 0;
Â  Â  Â  Â  bottom: 0;
Â  Â  Â  Â  background: rgba(0, 0, 0, 0.5);
Â  Â  Â  Â  z-index: 999;
Â  Â  Â  Â  display: none;
Â  Â  }
Â  Â  #menuOverlay.open {
Â  Â  Â  Â  display: block;
Â  Â  }
Â  }

Â  /* Menu header */
Â  #menuHeader {
Â  Â  Â  position: fixed;
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 60px;
Â  Â  Â  z-index: 1001;
Â  Â  Â  background: var(--panel);
Â  Â  Â  border-bottom: 1px solid var(--border);
Â  Â  Â  display: none;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  padding: 0 14px;
Â  }
Â  .sidepanel.open ~ #menuHeader {
Â  Â  Â  display: flex;
Â  }

Â  .icon-btn {
Â  Â  background: none;
Â  Â  border: none;
Â  Â  cursor: pointer;
Â  Â  padding: 8px;
Â  Â  color: var(--ink);
Â  Â  display: flex;
Â  Â  align-items: center;
Â  }
Â  .icon-btn svg {
Â  Â  width: 24px;
Â  Â  height: 24px;
Â  }
Â  #btnMenuOpen {
Â  Â  Â  display: none;
Â  }
Â  @media (max-width: 999px) {
Â  Â  Â  #btnMenuOpen {
Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  }
Â  }

Â  /* Form elements */
Â  .field{display:flex;align-items:center;gap:8px;background:#0f2032;border:1px solid var(--border);border-radius:10px;padding:.5rem .6rem}
Â  .field label{font-size:.85rem;color:var(--muted)}
Â  select,input[type="number"],input[type="text"]{background:#0c1c2b;color:var(--ink);border:1px solid var(--border);border-radius:8px;padding:.45rem .55rem}
Â  input[type="checkbox"]{width:18px;height:18px}
Â  .grow{flex:1}
Â  .subtle{color:var(--muted);font-size:.85rem}
Â  .row{display:flex;flex-wrap:wrap;gap:8px}

</style>

<script type="module">
Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
Â  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
Â  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
Â  import { getFirestore, doc, setDoc, deleteDoc, collection, query, onSnapshot, getDocs, where } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

Â  // Firebase configuration
Â  const firebaseConfig = {
Â  Â  apiKey: "AIzaSyACU3QfuTpW6PNRt3hHl9m1dy4Vso0GPoI",
Â  Â  authDomain: "bologna-rugby-club.firebaseapp.com",
Â  Â  projectId: "bologna-rugby-club",
Â  Â  storageBucket: "bologna-rugby-club.firebasestorage.app",
Â  Â  messagingSenderId: "641438144435",
Â  Â  appId: "1:641438144435:web:e2a243bacd522fd1615dc6",
Â  Â  measurementId: "G-9C66KXJ561"
Â  };

Â  // Initialize Firebase
Â  const app = initializeApp(firebaseConfig);
Â  const analytics = getAnalytics(app);
Â  const auth = getAuth(app);
Â  const db = getFirestore(app);

Â  // Exponer Firebase al Ã¡mbito global
Â  window.firebaseApp = app;
Â  window.firebaseAuth = auth;
Â  window.firebaseDb = db;
Â  window.firebaseSignIn = signInWithEmailAndPassword;
Â  window.firebaseSignOut = signOut;
Â  window.firebaseOnAuthStateChanged = onAuthStateChanged;
Â Â 
Â  // Funciones de Firestore
Â  window.firestore = {
Â  Â  doc, setDoc, deleteDoc, collection, query, onSnapshot, getDocs, where
Â  };

Â  console.log("Firebase inicializado correctamente");
</script>
</head>
<body>
Â  Â  <div id="menuOverlay" style="display:none;"></div>

Â  Â  <div class="modal-overlay" id="loginModal">
Â  Â  <div class="modal-content">
Â  Â  Â  Â  <h3 style="font-weight:700; color:var(--accent);">Acceso Bologna Rugby Club</h3>
Â  Â  Â  Â  <p class="subtle">Ingresa tus credenciales para acceder al tablero.</p>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <input type="email" id="loginEmail" placeholder="Email"/>
Â  Â  Â  Â  <input type="password" id="loginPassword" placeholder="ContraseÃ±a"/>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <button class="btn primary" id="btnLogin">Iniciar SesiÃ³n</button>
Â  Â  Â  Â  <p id="loginMessage" style="color:var(--red); font-size:0.85rem; margin:0;"></p>
Â  Â  Â  Â  <button class="btn" id="btnCloseLogin">Cerrar</button>
Â  Â  </div>
Â  </div>
Â Â 
Â  Â  <div id="menuHeader">
Â  Â  Â  <span class="brand" style="font-size: 1.1rem;"><span class="dot"></span>Controles</span>
Â  Â  Â  <button class="icon-btn" id="btnCloseMenu">
Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
Â  Â  Â  Â  Â  Â  Â  <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
Â  Â  Â  Â  Â  </svg>
Â  Â  Â  </button>
Â  </div>

Â  Â  <div class="app">
Â  Â  Â  Â  <header class="topbar">
Â  Â  Â  <div class="brand" id="brand"><span class="dot"></span>Bologna Rugby Club - RugbyBoard</div>

Â  Â  Â  <div class="toolbar">
Â  Â  Â  Â  <button class="btn primary" id="btnAuthAction">Iniciar SesiÃ³n</button>
Â  Â  Â  Â  <button class="icon-btn" id="btnMenuOpen">
Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â </button>
Â  Â  Â  </div>
Â  Â  </header>

Â  Â  Â  Â  <main class="stage">
Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <aside class="sidepanel" id="desktopSidepanel">
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="playerManagementSection" class="sidepanel-section" style="display:flex; flex-direction:column; gap:10px;">
Â  Â  Â  Â  Â  Â  <h3 style="font-weight:700; font-size:1.1rem; color:var(--accent);">Gestionar Jugadores</h3>
Â  Â  Â  Â  Â  Â  <div class="field grow">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="email" id="playerEmail" placeholder="Email del jugador" class="grow"/>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn grow" id="btnInvitePlayer">Invitar Jugador</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <p class="subtle">Los jugadores invitados podrÃ¡n ver tus jugadas.</p>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="orientationControls" class="sidepanel-section" style="display:flex; flex-direction:column; gap:10px;">
Â  Â  Â  Â  Â  Â  Â <h3 style="font-weight:700; font-size:1.1rem; color:var(--accent);">OrientaciÃ³n</h3>
Â  Â  Â  Â  Â  Â  Â <div class="seg" style="margin-top: 5px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnLandscape" class="active" title="Horizontal">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Horizontal
Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnPortrait" title="Vertical">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Vertical
Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="exportUtilitiesSection" class="sidepanel-section" style="display:flex; flex-direction:column; gap:10px;">
Â  Â  Â  Â  Â  <h3 style="font-weight:700; font-size:1.1rem; color:var(--accent);">ExportaciÃ³n</h3>
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <button class="btn grow" id="btnExportJpg">JPG</button>
Â  Â  Â  Â  Â  Â  <button class="btn grow" id="btnExportWebm">WebM</button>
Â  Â  Â  Â  Â  Â  <button class="btn grow" id="btnExportMp4">MP4</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  Â <button class="btn grow" id="btnReset">Reiniciar Tablero</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="drawingControlsSection" class="sidepanel-section" style="display:flex; flex-direction:column; gap:10px;">
Â  Â  Â  Â  Â  <h3 style="font-weight:700; font-size:1.1rem; color:var(--accent);">Herramientas de Dibujo</h3>
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="seg" id="toolSeg">
Â  Â  Â  Â  Â  Â  Â  <button id="toolArrows" class="active">Flechas</button>
Â  Â  Â  Â  Â  Â  Â  <button id="toolPen">LÃ¡piz</button>
Â  Â  Â  Â  Â  Â  Â  <button id="toolText">Texto</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button class="btn" id="btnUndo">Deshacer</button>
Â  Â  Â  Â  Â  Â  <button class="btn" id="btnClear">Borrar</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="field">
Â  Â  Â  Â  Â  Â  Â  <label>Color</label>
Â  Â  Â  Â  Â  Â  Â  <select id="strokeColor">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="#ffffff">Blanco</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="#35d07f">Verde</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="#2f80ff">Azul</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="#ff5a6b">Rojo</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="#ffd400" selected>Amarillo</option>
Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="field">
Â  Â  Â  Â  Â  Â  Â  <label>Grosor</label>
Â  Â  Â  Â  Â  Â  Â  <select id="strokeWidth">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="3">Fino</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="5" selected>Medio</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="7">Grueso</option>
Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="field">
Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="dashed"> <label for="dashed">Punteado</label>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="field">
Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="showGrid"> <label for="showGrid">Ver grilla</label>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="playManagementSection" class="sidepanel-section" style="display:flex; flex-direction:column; gap:10px;">
Â  Â  Â  Â  Â  <h3 style="font-weight:700; font-size:1.1rem; color:var(--accent);">GestiÃ³n de Jugadas</h3>
Â  Â  Â  Â  Â  <div class="field grow">
Â  Â  Â  Â  Â  Â  <label class="subtle">Nombre de Jugada</label>
Â  Â  Â  Â  Â  Â  <input type="text" id="playName" placeholder="Ej: Lineout 8" class="grow"/>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <button class="btn" id="btnDuplicate">Duplicar</button>
Â  Â  Â  Â  Â  Â  <select id="playList" class="btn grow">
Â  Â  Â  Â  Â  Â  Â  <option value="">Inicia sesiÃ³n para ver jugadas</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  <button class="btn" id="btnDelete">Eliminar</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <button class="btn grow" id="btnSavePlay">Guardar Jugada</button>
Â  Â  Â  Â  Â  Â  <button class="btn grow" id="btnLoadPlay">Cargar Jugada</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="timelineSection" class="sidepanel-section" style="display:flex; flex-direction:column; gap:10px;">
Â  Â  Â  Â  Â  <h3 style="font-weight:700; font-size:1.1rem; color:var(--accent);">Control de AnimaciÃ³n</h3>
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <button class="btn grow" id="btnRecord">Grabar paso</button>
Â  Â  Â  Â  Â  Â  <div class="field">
Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="autoRec"> <label for="autoRec">Auto al soltar</label>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <button class="btn primary" id="btnPlayPause">Reproducir</button>
Â  Â  Â  Â  Â  Â  <button class="btn" id="btnStop">Stop</button>
Â  Â  Â  Â  Â  Â  <div class="field grow">
Â  Â  Â  Â  Â  Â  Â  <label>Velocidad (ms)</label>
Â  Â  Â  Â  Â  Â  Â  <input type="number" id="speed" min="100" step="100" value="800" style="width:100px"/>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="field grow">
Â  Â  Â  Â  Â  Â  <label>Frame</label>
Â  Â  Â  Â  Â  Â  <input type="range" id="scrubber" min="0" max="0" value="0" class="grow"/>
Â  Â  Â  Â  Â  Â  <span id="scrubLbl" class="subtle">0/0</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <button class="btn" id="btnClrTl">Limpiar animaciÃ³n</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </aside>

Â  Â  Â  <section class="board-viewport" id="boardViewport">
Â  Â  Â  Â  <div class="board-wrap" id="boardWrap">
Â  Â  Â  Â  Â  <div class="board" id="board">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="lines" viewBox="0 0 1200 700" preserveAspectRatio="none" aria-hidden="true">
Â  Â  Â  Â  Â  Â  Â  <rect x="5" y="5" width="1190" height="690" fill="none" stroke="#fff" stroke-width="6"/>
Â  Â  Â  Â  Â  Â  Â  <rect x="0" y="0" width="80" height="700" fill="rgba(255,255,255,.07)"/>
Â  Â  Â  Â  Â  Â  Â  <rect x="1120" y="0" width="80" height="700" fill="rgba(255,255,255,.07)"/>
Â  Â  Â  Â  Â  Â  Â  <line x1="80" y1="0" x2="80" y2="700" stroke="#fff" stroke-width="4"/>
Â  Â  Â  Â  Â  Â  Â  <line x1="1120" y1="0" x2="1120" y2="700" stroke="#fff" stroke-width="4"/>
Â  Â  Â  Â  Â  Â  Â  <line x1="309" y1="0" x2="309" y2="700" stroke="#fff" stroke-width="3"/>
Â  Â  Â  Â  Â  Â  Â  <line x1="891" y1="0" x2="891" y2="700" stroke="#fff" stroke-width="3"/>
Â  Â  Â  Â  Â  Â  Â  <line x1="500" y1="0" x2="500" y2="700" stroke="#fff" stroke-width="2" stroke-dasharray="8 10"/>
Â  Â  Â  Â  Â  Â  Â  <line x1="697" y1="0" x2="697" y2="700" stroke="#fff" stroke-width="2" stroke-dasharray="8 10"/>
Â  Â  Â  Â  Â  Â  Â  <line x1="600" y1="0" x2="600" y2="700" stroke="#fff" stroke-width="4"/>
Â  Â  Â  Â  Â  Â  Â  <line x1="5" y1="50" x2="1195" y2="50" stroke="#fff" stroke-width="2" stroke-dasharray="4 8"/>
Â  Â  Â  Â  Â  Â  Â  <line x1="5" y1="150" x2="1195" y2="150" stroke="#fff" stroke-width="2" stroke-dasharray="4 8"/>
Â  Â  Â  Â  Â  Â  Â  <line x1="5" y1="550" x2="1195" y2="550" stroke="#fff" stroke-width="2" stroke-dasharray="4 8"/>
Â  Â  Â  Â  Â  Â  Â  <line x1="5" y1="650" x2="1195" y2="650" stroke="#fff" stroke-width="2" stroke-dasharray="4 8"/>
Â  Â  Â  Â  Â  Â  Â  <line x1="130" y1="0" x2="130" y2="700" stroke="#fff" stroke-width="2" stroke-dasharray="8 10"/>
Â  Â  Â  Â  Â  Â  Â  <line x1="1070" y1="0" x2="1070" y2="700" stroke="#fff" stroke-width="2" stroke-dasharray="8 10"/>
Â  Â  Â  Â  Â  Â  </svg>

Â  Â  Â  Â  Â  Â  <svg class="grid" id="grid" viewBox="0 0 1200 700" preserveAspectRatio="none"></svg>
Â  Â  Â  Â  Â  Â  <svg class="draw" id="draw" viewBox="0 0 1200 700" preserveAspectRatio="none"></svg>
Â  Â  Â  Â  Â  Â  <div id="players"></div>
Â  Â  Â  Â  Â  Â  <div id="ball" class="ball" title="BalÃ³n"></div>
Â  Â  Â  Â  Â  Â  <div id="selectionBox" style="display:none;"></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="exportCanvas" width="1200" height="700" style="display:none"></canvas>
Â  Â  Â  </section>
Â  Â  </main>
Â  </div>

<script>
// ==================== INICIALIZACIÃ“N FFMPEG ====================
let ffmpeg = null;
async function loadFfmpeg() {
Â  Â  if (ffmpeg) return ffmpeg;
Â  Â  try {
Â  Â  Â  Â  // Asegurarse de que el script se cargue
Â  Â  Â  Â  if (window.FFmpeg) {
Â  Â  Â  Â  Â  Â  ffmpeg = new window.FFmpeg.FFmpeg();
Â  Â  Â  Â  Â  Â  ffmpeg.on('log', ({ message }) => console.log('[FFMPEG]', message));
Â  Â  Â  Â  Â  Â  ffmpeg.on('progress', ({ progress, time }) => {
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`[FFMPEG] Progreso: ${(progress * 100).toFixed(2)}%`);
Â  Â  Â  Â  Â  Â  Â  Â  showStatus(`Exportando video: ${(progress * 100).toFixed(0)}%`, 'var(--warn)');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  await ffmpeg.load();
Â  Â  Â  Â  Â  Â  showStatus('FFMPEG cargado, listo para exportar video', 'var(--accent2)');
Â  Â  Â  Â  Â  Â  return ffmpeg;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  throw new Error('FFmpeg global object not found');
Â  Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error('Error al cargar FFMPEG:', e);
Â  Â  Â  Â  showStatus('ERROR: No se pudo cargar FFMPEG para exportar video.', 'var(--red)');
Â  Â  Â  Â  return null;
Â  Â  }
}


// Constantes
const WIDTH = 1200, HEIGHT = 700, GRID = 24;
const PLAYER_SIZE = 40; // TamaÃ±o base del jugador
const FRAME_RATE = 20; // FPS para la exportaciÃ³n de video

// Variables DOM
let desktopSidepanel, boardViewport, boardWrap, board, playersLayer, draw, gridSvg, ball, exportCanvas, ctx, selectionBox, loginModal, btnAuthAction, menuOverlay, btnCloseMenu, btnMenuOpen;
let btnLandscape, btnPortrait, btnReset, btnSavePlay, btnLoadPlay, btnExportJpg, btnExportWebm, btnExportMp4;
let toolArrows, toolPen, toolText, strokeColor, strokeWidth, dashed, showGrid, btnUndo, btnClear;
let playName, btnDuplicate, playList, btnDelete, btnRecord, autoRec, btnPlayPause, btnStop, speed, scrubber, scrubLbl, btnClrTl;
let btnInvitePlayer, playerEmail;

// FunciÃ³n que asigna todas las variables DOM
function assignDOMElements() {
Â  Â  desktopSidepanel = document.getElementById('desktopSidepanel');
Â  Â  boardViewport = document.getElementById('boardViewport');
Â  Â  boardWrap = document.getElementById('boardWrap');
Â  Â  board = document.getElementById('board');
Â  Â  playersLayer = document.getElementById('players');
Â  Â  draw = document.getElementById('draw');
Â  Â  gridSvg = document.getElementById('grid');
Â  Â  ball = document.getElementById('ball');
Â  Â  exportCanvas = document.getElementById('exportCanvas');
Â  Â  ctx = exportCanvas ? exportCanvas.getContext('2d') : null;
Â  Â  selectionBox = document.getElementById('selectionBox');
Â  Â  loginModal = document.getElementById('loginModal');
Â  Â  btnAuthAction = document.getElementById('btnAuthAction');
Â  Â  menuOverlay = document.getElementById('menuOverlay');
Â  Â  btnCloseMenu = document.getElementById('btnCloseMenu');
Â  Â  btnMenuOpen = document.getElementById('btnMenuOpen');

Â  Â  // Topbar / acciones
Â  Â  btnLandscape = document.getElementById('btnLandscape');
Â  Â  btnPortrait = document.getElementById('btnPortrait');
Â  Â  btnReset = document.getElementById('btnReset');
Â  Â  btnSavePlay = document.getElementById('btnSavePlay');
Â  Â  btnLoadPlay = document.getElementById('btnLoadPlay');
Â  Â  btnExportJpg = document.getElementById('btnExportJpg');
Â  Â  btnExportWebm = document.getElementById('btnExportWebm');
Â  Â  btnExportMp4 = document.getElementById('btnExportMp4');

Â  Â  // Herramientas
Â  Â  toolArrows = document.getElementById('toolArrows');
Â  Â  toolPen = document.getElementById('toolPen');
Â  Â  toolText = document.getElementById('toolText');
Â  Â  strokeColor = document.getElementById('strokeColor');
Â  Â  strokeWidth = document.getElementById('strokeWidth');
Â  Â  dashed = document.getElementById('dashed');
Â  Â  showGrid = document.getElementById('showGrid');
Â  Â  btnUndo = document.getElementById('btnUndo');
Â  Â  btnClear = document.getElementById('btnClear');

Â  Â  // Jugadas
Â  Â  playName = document.getElementById('playName');
Â  Â  btnDuplicate = document.getElementById('btnDuplicate');
Â  Â  playList = document.getElementById('playList');
Â  Â  btnDelete = document.getElementById('btnDelete');

Â  Â  // Timeline
Â  Â  btnRecord = document.getElementById('btnRecord');
Â  Â  autoRec = document.getElementById('autoRec');
Â  Â  btnPlayPause = document.getElementById('btnPlayPause');
Â  Â  btnStop = document.getElementById('btnStop');
Â  Â  speed = document.getElementById('speed');
Â  Â  scrubber = document.getElementById('scrubber');
Â  Â  scrubLbl = document.getElementById('scrubLbl');
Â  Â  btnClrTl = document.getElementById('btnClrTl');

Â  Â  // GestiÃ³n de jugadores
Â  Â  btnInvitePlayer = document.getElementById('btnInvitePlayer');
Â  Â  playerEmail = document.getElementById('playerEmail');
}

// Variables de estado del tablero
let arrows = [], strokes = [], notes = [], timeline = [];
let teamConfig = {Â 
Â  Â  team1: { name: 'Bologna RFC', colorClass: 'team-1', hexColor: '#2f80ff' },
Â  Â  team2: { name: 'Rival', colorClass: 'team-2', hexColor: '#ff5a6b' }
};
const initialPositions = [];
for(let i=1;i<=15;i++) initialPositions.push({team:'team-1', number:i, x:WIDTH*0.18,y:HEIGHT*(0.1+(i-1)*(0.8/14))});
for(let i=1;i<=15;i++) initialPositions.push({team:'team-2', number:i, x:WIDTH*0.82,y:HEIGHT*(0.1+(i-1)*(0.8/14))});
let currentBallPos = {x:WIDTH/2,y:HEIGHT/2};
let selectedPlayers = new Set();
let isDraggingPlayer = false; // Nueva variable de estado para el arrastre
let isDraggingBall = false;

// Variables de animaciÃ³n
let playing = false, isRecordingVideo = false, playIdx = 0, rafId = null, segStart = 0, segDur = 800;
let frameTimeoutId = null;

// Layout
let layout = {mode: 'landscape', scale: 1, tx: 0, ty: 0};
let forcePortrait = false;

// Estado de autenticaciÃ³n
let isAuthorized = false;
let currentUser = null;
let userRole = 'spectator';
let currentCoachId = null;
let unsubscribePlays = null;

// Herramienta actual de dibujo
let currentTool = 'arrows';

// Utilidades
function showStatus(message, color='var(--accent)'){
Â  Â  const statusDiv = document.createElement('div');
Â  Â  statusDiv.className = 'status-message';
Â  Â  statusDiv.textContent = message;
Â  Â  statusDiv.style.cssText = `
Â  Â  Â  Â  position: fixed; top: 70px; right: 20px;
Â  Â  Â  Â  background: ${color}; color: var(--bg); padding: 10px 15px;
Â  Â  Â  Â  border-radius: 8px; z-index: 9999; opacity: 0;
Â  Â  Â  Â  transition: opacity 0.5s ease-in-out;
Â  Â  Â  Â  max-width: 80%; /* Para mÃ³vil */
Â  Â  `;
Â  Â  document.body.appendChild(statusDiv);
Â  Â Â 
Â  Â  setTimeout(() => { statusDiv.style.opacity = 1; }, 10);
Â  Â  setTimeout(() => { statusDiv.style.opacity = 0; }, 3000);
Â  Â  setTimeout(() => { statusDiv.remove(); }, 3500);
}

function clamp(v, min, max){ return Math.max(min,Math.min(max,v)); }
function dist(ax,ay,bx,by){ const dx=ax-bx, dy=ay-by; return Math.hypot(dx,dy); }
function centerOf(el){ return { x:parseFloat(el.style.left)||0, y:parseFloat(el.style.top)||0 } }
function rectIntersect(rect1, rect2) {
Â  Â  return rect1.left < rect2.right &&
Â  Â  Â  Â  Â  Â rect1.right > rect2.left &&
Â  Â  Â  Â  Â  Â rect1.top < rect2.bottom &&
Â  Â  Â  Â  Â  Â rect1.bottom > rect2.top;
}
function getPlayerRect(player) {
Â  Â  const x = parseFloat(player.style.left) || 0;
Â  Â  const y = parseFloat(player.style.top) || 0;
Â  Â  const halfSize = PLAYER_SIZE / 2;
Â  Â  return {
Â  Â  Â  Â  left: x - halfSize,
Â  Â  Â  Â  right: x + halfSize,
Â  Â  Â  Â  top: y - halfSize,
Â  Â  Â  Â  bottom: y + halfSize
Â  Â  };
}

// ==================== SISTEMA DE AUTENTICACIÃ“N ====================
// (LÃ³gica de autenticaciÃ³n: sin cambios significativos)

function openLoginModal() {
Â  Â  if(loginModal) loginModal.style.display = 'grid';
}

function closeLoginModal() {
Â  Â  if(loginModal) loginModal.style.display = 'none';
Â  Â  document.getElementById('loginEmail').value = '';
Â  Â  document.getElementById('loginPassword').value = '';
Â  Â  document.getElementById('loginMessage').textContent = '';
}

async function handleLogin() {
Â  Â  const email = document.getElementById('loginEmail').value;
Â  Â  const password = document.getElementById('loginPassword').value;
Â  Â  const loginMessage = document.getElementById('loginMessage');
Â  Â Â 
Â  Â  if (!email || !password) {
Â  Â  Â  Â  loginMessage.textContent = 'Por favor ingresa email y contraseÃ±a';
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  loginMessage.textContent = 'Iniciando sesiÃ³n...';
Â  Â  Â  Â  const userCredential = await window.firebaseSignIn(window.firebaseAuth, email, password);
Â  Â  Â  Â  currentUser = userCredential.user;
Â  Â  Â  Â  isAuthorized = true;
Â  Â  Â  Â Â 
Â  Â  Â  Â  showStatus('Â¡SesiÃ³n iniciada correctamente!', 'var(--accent2)');
Â  Â  Â  Â  closeLoginModal();
Â  Â  Â  Â Â 
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Error de login:', error);
Â  Â  Â  Â  let errorMessage = 'Error al iniciar sesiÃ³n';
Â  Â  Â  Â Â 
Â  Â  Â  Â  switch(error.code) {
Â  Â  Â  Â  Â  Â  case 'auth/invalid-email':
Â  Â  Â  Â  Â  Â  Â  Â  errorMessage = 'Email invÃ¡lido';
Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  case 'auth/user-disabled':
Â  Â  Â  Â  Â  Â  Â  Â  errorMessage = 'Usuario deshabilitado';
Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  case 'auth/user-not-found':
Â  Â  Â  Â  Â  Â  Â  Â  errorMessage = 'Usuario no encontrado';
Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  case 'auth/wrong-password':
Â  Â  Â  Â  Â  Â  Â  Â  errorMessage = 'ContraseÃ±a incorrecta';
Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  Â  Â  Â  errorMessage = error.message;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  loginMessage.textContent = errorMessage;
Â  Â  }
}

async function handleLogout() {
Â  Â  try {
Â  Â  Â  Â  await window.firebaseSignOut(window.firebaseAuth);
Â  Â  Â  Â  currentUser = null;
Â  Â  Â  Â  isAuthorized = false;
Â  Â  Â  Â  userRole = 'spectator';
Â  Â  Â  Â  currentCoachId = null;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (unsubscribePlays) {
Â  Â  Â  Â  Â  Â  unsubscribePlays();
Â  Â  Â  Â  Â  Â  unsubscribePlays = null;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  showStatus('SesiÃ³n cerrada', 'var(--accent)');
Â  Â  Â  Â  updateAuthUI();
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Error al cerrar sesiÃ³n:', error);
Â  Â  Â  Â  showStatus('Error al cerrar sesiÃ³n', 'var(--red)');
Â  Â  }
}

// ==================== SISTEMA MULTI-TENANCY ====================
// (LÃ³gica de Multi-tenancy: sin cambios significativos)

async function checkPlayerAccess() {
Â  Â  if (!currentUser) { return null; }
Â  Â Â 
Â  Â  // TEMPORAL: Todos los usuarios son coaches
Â  Â  userRole = 'coach';
Â  Â  currentCoachId = currentUser.uid;
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  const coachDocRef = window.firestore.doc(
Â  Â  Â  Â  Â  Â  window.firestore.collection(window.firebaseDb, 'coaches'),Â 
Â  Â  Â  Â  Â  Â  currentUser.uid
Â  Â  Â  Â  );
Â  Â  Â  Â  await window.firestore.setDoc(coachDocRef, {
Â  Â  Â  Â  Â  Â  email: currentUser.email,
Â  Â  Â  Â  Â  Â  createdAt: new Date().toISOString(),
Â  Â  Â  Â  Â  Â  role: 'coach',
Â  Â  Â  Â  Â  Â  name: currentUser.displayName || currentUser.email.split('@')[0],
Â  Â  Â  Â  Â  Â  lastLogin: new Date().toISOString()
Â  Â  Â  Â  }, { merge: true }); // Usar merge para no sobrescribir
Â  Â  Â  Â Â 
Â  Â  Â  Â  //showStatus('Â¡Bienvenido Coach! Espacio personal creado', 'var(--accent2)');
Â  Â  Â  Â Â 
Â  Â  } catch (error) {
Â  Â  Â  Â  console.log('âš ï¸Â  Info del documento (puede que ya exista):', error.message);
Â  Â  }
Â  Â Â 
Â  Â  return [];
}

async function determineUserRole() {
Â  Â  if (!currentUser) {
Â  Â  Â  Â  userRole = 'spectator';
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  await checkPlayerAccess();
}

function getCoachPlaysCollectionRef(coachId = null) {
Â  Â  const coachUID = coachId || currentCoachId || currentUser.uid;
Â  Â  return window.firestore.collection(window.firebaseDb, `coaches/${coachUID}/plays`);
}

function getCoachPlayersCollectionRef(coachId = null) {
Â  Â  const coachUID = coachId || currentCoachId || currentUser.uid;
Â  Â  return window.firestore.collection(window.firebaseDb, `coaches/${coachUID}/players`);
}

async function invitePlayer(playerEmail) {
Â  Â  if (!isAuthorized || userRole !== 'coach') {
Â  Â  Â  Â  showStatus('ERROR: Solo los entrenadores pueden invitar jugadores.', 'var(--red)');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  if (!playerEmail) {
Â  Â  Â  Â  showStatus('Ingresa un email vÃ¡lido', 'var(--red)');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  try {
Â  Â  Â  Â  // La ID del documento es el email sanitizado
Â  Â  Â  Â  const docId = playerEmail.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
Â  Â  Â  Â  const playerDocRef = window.firestore.doc(
Â  Â  Â  Â  Â  Â  getCoachPlayersCollectionRef(),Â 
Â  Â  Â  Â  Â  Â  docId
Â  Â  Â  Â  );
Â  Â  Â  Â Â 
Â  Â  Â  Â  await window.firestore.setDoc(playerDocRef, {
Â  Â  Â  Â  Â  Â  email: playerEmail,
Â  Â  Â  Â  Â  Â  invitedBy: currentUser.uid,
Â  Â  Â  Â  Â  Â  invitedAt: new Date().toISOString(),
Â  Â  Â  Â  Â  Â  status: 'pending'
Â  Â  Â  Â  }, { merge: true });
Â  Â  Â  Â Â 
Â  Â  Â  Â  showStatus(`InvitaciÃ³n registrada para ${playerEmail}. NOTA: El email debe ser enviado por un servicio de backend (Cloud Function).`, 'var(--warn)');
Â  Â  Â  Â  document.getElementById('playerEmail').value = '';
Â  Â  Â  Â Â 
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Error al invitar jugador:', error);
Â  Â  Â  Â  showStatus('Error al registrar invitaciÃ³n', 'var(--red)');
Â  Â  }
}

// ==================== GESTIÃ“N DE JUGADAS ====================

function snapshotPlayers(){Â 
Â  Â  if (!playersLayer) return [];
Â  Â  return [...playersLayer.children].map(el=>({
Â  Â  Â  Â  team:el.dataset.team,Â 
Â  Â  Â  Â  number:+el.dataset.number,Â 
Â  Â  Â  Â  x:parseFloat(el.style.left)||0,Â 
Â  Â  Â  Â  y:parseFloat(el.style.top)||0
Â  Â  }));Â 
}

function snapshotBall(){ return {...currentBallPos}; }
function snapshotFrame(){Â 
Â  Â  return {Â 
Â  Â  Â  Â  players: snapshotPlayers(),Â 
Â  Â  Â  Â  ball: snapshotBall()Â 
Â  Â  };Â 
}

// Guardar jugada en el espacio del entrenador
async function savePlay(name) {
Â  Â  if (!isAuthorized || !currentUser || userRole !== 'coach') {
Â  Â  Â  Â  showStatus('ERROR: Debes ser entrenador para guardar jugadas.', 'var(--red)');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  if (timeline.length === 0) {
Â  Â  Â  Â  recordFrame(); // Asegurar al menos el primer frame
Â  Â  }

Â  Â  const playId = name.replace(/[^a-zA-Z0-9_-]/g, '_').toLowerCase();Â 
Â  Â  const payload = {Â 
Â  Â  Â  Â  name: name,
Â  Â  Â  Â  positions: snapshotPlayers(),Â 
Â  Â  Â  Â  ball: snapshotBall(),
Â  Â  Â  Â  arrows: arrows,Â 
Â  Â  Â  Â  strokes: strokes,Â 
Â  Â  Â  Â  notes: notes,
Â  Â  Â  Â  timeline: timeline,
Â  Â  Â  Â  teamConfig: teamConfig,
Â  Â  Â  Â  createdBy: currentUser.uid,
Â  Â  Â  Â  createdAt: new Date().toISOString(),
Â  Â  Â  Â  updatedAt: new Date().toISOString(),
Â  Â  Â  Â  isPublic: false
Â  Â  };

Â  Â  try {
Â  Â  Â  Â  await window.firestore.setDoc(
Â  Â  Â  Â  Â  Â  window.firestore.doc(getCoachPlaysCollectionRef(), playId),Â 
Â  Â  Â  Â  Â  Â  payload
Â  Â  Â  Â  );
Â  Â  Â  Â  showStatus('Jugada guardada en tu espacio personal!', 'var(--accent2)');
Â  Â  Â  Â  // No es necesario llamar a refreshPlayList aquÃ­ gracias al listener onSnapshot
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Error al guardar jugada:", e);
Â  Â  Â  Â  showStatus('Error al guardar: ' + e.message, 'var(--red)');
Â  Â  }
}

// Cargar jugadas del entrenador actual (con listener en tiempo real)
function refreshPlayList() {
Â  Â  if (!currentUser || !currentCoachId) {
Â  Â  Â  Â  if (playList) {
Â  Â  Â  Â  Â  Â  playList.innerHTML = '<option value="">Inicia sesiÃ³n para ver jugadas</option>';
Â  Â  Â  Â  }
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  if (unsubscribePlays) { unsubscribePlays(); }

Â  Â  try {
Â  Â  Â  Â  const playsCollection = getCoachPlaysCollectionRef();
Â  Â  Â  Â  const q = window.firestore.query(playsCollection);
Â  Â  Â  Â Â 
Â  Â  Â  Â  unsubscribePlays = window.firestore.onSnapshot(q,Â 
Â  Â  Â  Â  Â  Â  (snapshot) => {
Â  Â  Â  Â  Â  Â  Â  Â  const jugadas = [];
Â  Â  Â  Â  Â  Â  Â  Â  snapshot.forEach((doc) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = doc.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  jugadas.push({Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: doc.id,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: data.name || doc.id,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  payload: JSON.stringify(data)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  populatePlayList(jugadas);
Â  Â  Â  Â  Â  Â  },Â 
Â  Â  Â  Â  Â  Â  (error) => {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('ðŸ’¥ ERROR en suscripciÃ³n:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showStatus('Error de conexiÃ³n: ' + error.code, 'var(--red)');
Â  Â  Â  Â  Â  Â  Â  Â  if (playList) playList.innerHTML = '<option value="">Error cargando jugadas</option>';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  );
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('ðŸ’¥ ERROR en refreshPlayList:', error);
Â  Â  Â  Â  showStatus('Error: ' + error.message, 'var(--red)');
Â  Â  }
}

function populatePlayList(jugadas) {
Â  Â  if (!playList) return;
Â  Â Â 
Â  Â  playList.innerHTML = '';
Â  Â  const placeholder = document.createElement('option');
Â  Â  placeholder.value = '';
Â  Â  placeholder.textContent = jugadas.length > 0 ? '--- Seleccionar Jugada ---' : 'No hay jugadas guardadas';
Â  Â  placeholder.disabled = true;
Â  Â  placeholder.selected = true;
Â  Â  playList.appendChild(placeholder);
Â  Â Â 
Â  Â  jugadas.forEach(j => {
Â  Â  Â  Â  const opt = document.createElement('option');
Â  Â  Â  Â  opt.value = j.id;
Â  Â  Â  Â  opt.textContent = j.name;
Â  Â  Â  Â  opt.dataset.payload = j.payload;
Â  Â  Â  Â  playList.appendChild(opt);
Â  Â  });
}

// Cargar una jugada especÃ­fica
function loadPlay(playId) {
Â  Â  if (!playList) return;
Â  Â Â 
Â  Â  const option = Array.from(playList.options).find(opt => opt.value === playId);
Â  Â  if (!option || !option.dataset.payload) {
Â  Â  Â  Â  showStatus('Jugada no encontrada', 'var(--red)');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  try {
Â  Â  Â  Â  const data = JSON.parse(option.dataset.payload);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Limpiar antes de cargar
Â  Â  Â  Â  stopAnimation();
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (playName) playName.value = data.name || playId;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Limpiar y recrear jugadores
Â  Â  Â  Â  if (playersLayer) playersLayer.innerHTML = '';
Â  Â  Â  Â  selectedPlayers.clear();
Â  Â  Â  Â Â 
Â  Â  Â  Â  (data.positions || []).forEach(p => {
Â  Â  Â  Â  Â  Â  const el = document.createElement('div');
Â  Â  Â  Â  Â  Â  const teamData = p.team === 'team-1' ? teamConfig.team1 : teamConfig.team2;
Â  Â  Â  Â  Â  Â  el.className = `player ${teamData.colorClass}`;Â 
Â  Â  Â  Â  Â  Â  el.textContent = p.number;
Â  Â  Â  Â  Â  Â  el.dataset.team = p.team;Â 
Â  Â  Â  Â  Â  Â  el.dataset.number = p.number;
Â  Â  Â  Â  Â  Â  el.style.left = p.x + 'px';Â 
Â  Â  Â  Â  Â  Â  el.style.top = p.y + 'px';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Se re-inicializa el drag en reInitializePlayerInteractions
Â  Â  Â  Â  Â  Â  if (playersLayer) playersLayer.appendChild(el);
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  reInitializePlayerInteractions(); // Vuelve a habilitar el drag para los nuevos elementos

Â  Â  Â  Â  // Cargar balÃ³n
Â  Â  Â  Â  placeBall(data.ball?.x || WIDTH/2, data.ball?.y || HEIGHT/2);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Cargar elementos de dibujo
Â  Â  Â  Â  arrows = data.arrows || [];
Â  Â  Â  Â  strokes = data.strokes || [];
Â  Â  Â  Â  notes = data.notes || [];
Â  Â  Â  Â  timeline = Array.isArray(data.timeline) ? data.timeline : [];
Â  Â  Â  Â Â 
Â  Â  Â  Â  renderDraw();Â 
Â  Â  Â  Â  updateScrub();Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (timeline.length) gotoFrame(0);

Â  Â  Â  Â  showStatus(`Jugada '${data.name}' cargada`, 'var(--accent)');

Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Error al cargar jugada:", e);
Â  Â  Â  Â  showStatus('Error al cargar la jugada.', 'var(--red)');
Â  Â  }
}


// ==================== FUNCIONES DE INTERACCIÃ“N COMPLETAS (Corregidas) ====================

function enableDragPlayer(playerEl, onDrop) {
Â  Â  if (userRole !== 'coach') return;
Â  Â Â 
Â  Â  let pid = null, sx = 0, sy = 0, ox = 0, oy = 0, isMoving = false;
Â  Â Â 
Â  Â  const down = e => {
Â  Â  Â  Â  if (userRole !== 'coach') return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  pid = e.pointerId;Â 
Â  Â  Â  Â  playerEl.setPointerCapture(pid);Â 
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  sx = e.clientX;Â 
Â  Â  Â  Â  sy = e.clientY;
Â  Â  Â  Â  ox = parseFloat(playerEl.style.left) || 0;
Â  Â  Â  Â  oy = parseFloat(playerEl.style.top) || 0;
Â  Â  Â  Â Â 
Â  Â  Â  Â  isDraggingPlayer = true;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Si no estÃ¡ seleccionado, limpia selecciÃ³n y lo selecciona
Â  Â  Â  Â  if (!playerEl.classList.contains('selected')) {
Â  Â  Â  Â  Â  Â  clearPlayerSelection();
Â  Â  Â  Â  Â  Â  playerEl.classList.add('selected');
Â  Â  Â  Â  Â  Â  selectedPlayers.add(playerEl);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Mapa para guardar la posiciÃ³n relativa de cada jugador en el grupo
Â  Â  Â  Â  const initialOffsets = new Map();
Â  Â  Â  Â  selectedPlayers.forEach(p => {
Â  Â  Â  Â  Â  Â  initialOffsets.set(p, {
Â  Â  Â  Â  Â  Â  Â  Â  dx: (parseFloat(p.style.left) || 0) - ox,
Â  Â  Â  Â  Â  Â  Â  Â  dy: (parseFloat(p.style.top) || 0) - oy,
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });

Â  Â  Â  Â  const move = ev => {
Â  Â  Â  Â  Â  Â  if (ev.pointerId !== pid || userRole !== 'coach') return;
Â  Â  Â  Â  Â  Â  ev.preventDefault();
Â  Â  Â  Â  Â  Â  isMoving = true;
Â  Â  Â  Â  Â  Â  const {dx, dy} = deltaToBoard(ev.clientX - sx, ev.clientY - sy);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Mover el grupo
Â  Â  Â  Â  Â  Â  selectedPlayers.forEach(p => {
Â  Â  Â  Â  Â  Â  Â  Â  const offset = initialOffsets.get(p);
Â  Â  Â  Â  Â  Â  Â  Â  const newX = clamp(ox + dx + offset.dx, 0, WIDTH);
Â  Â  Â  Â  Â  Â  Â  Â  const newY = clamp(oy + dy + offset.dy, 0, HEIGHT);
Â  Â  Â  Â  Â  Â  Â  Â  p.style.left = newX + 'px';
Â  Â  Â  Â  Â  Â  Â  Â  p.style.top = newY + 'px';
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  };

Â  Â  Â  Â  const up = ev => {
Â  Â  Â  Â  Â  Â  if (ev.pointerId !== pid) return;
Â  Â  Â  Â  Â  Â  try { playerEl.releasePointerCapture(pid); } catch {}
Â  Â  Â  Â  Â  Â  document.removeEventListener('pointermove', move);
Â  Â  Â  Â  Â  Â  document.removeEventListener('pointerup', up);
Â  Â  Â  Â  Â  Â  isDraggingPlayer = false;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (isMoving && userRole === 'coach') {
Â  Â  Â  Â  Â  Â  Â  Â  onDrop && onDrop();
Â  Â  Â  Â  Â  Â  } else if (!isMoving) {
Â  Â  Â  Â  Â  Â  Â  Â  // Si no hubo movimiento (solo click), mantiene la selecciÃ³n
Â  Â  Â  Â  Â  Â  Â  Â  clearPlayerSelection();
Â  Â  Â  Â  Â  Â  Â  Â  playerEl.classList.add('selected');
Â  Â  Â  Â  Â  Â  Â  Â  selectedPlayers.add(playerEl);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  isMoving = false;
Â  Â  Â  Â  };

Â  Â  Â  Â  document.addEventListener('pointermove', move, {passive: false});
Â  Â  Â  Â  document.addEventListener('pointerup', up, {passive: false});
Â  Â  };

Â  Â  playerEl.addEventListener('pointerdown', down, {passive: false});
Â  Â  playerEl.ondragstart = () => false;
}

function enableDragBall(onDrop) {
Â  Â  if (userRole !== 'coach') return;
Â  Â Â 
Â  Â  let pid = null, sx = 0, sy = 0, ox = 0, oy = 0;
Â  Â Â 
Â  Â  const down = e => {
Â  Â  Â  Â  if (userRole !== 'coach') return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  pid = e.pointerId;Â 
Â  Â  Â  Â  ball.setPointerCapture(pid);Â 
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  sx = e.clientX;Â 
Â  Â  Â  Â  sy = e.clientY;
Â  Â  Â  Â  ox = currentBallPos.x;
Â  Â  Â  Â  oy = currentBallPos.y;
Â  Â  Â  Â  isDraggingBall = true;

Â  Â  Â  Â  // Limpiar selecciÃ³n al tocar el balÃ³n
Â  Â  Â  Â  clearPlayerSelection();

Â  Â  Â  Â  const move = ev => {
Â  Â  Â  Â  Â  Â  if (ev.pointerId !== pid || userRole !== 'coach') return;
Â  Â  Â  Â  Â  Â  ev.preventDefault();
Â  Â  Â  Â  Â  Â  const {dx, dy} = deltaToBoard(ev.clientX - sx, ev.clientY - sy);
Â  Â  Â  Â  Â  Â  const nx = clamp(ox + dx, 0, WIDTH);
Â  Â  Â  Â  Â  Â  const ny = clamp(oy + dy, 0, HEIGHT);
Â  Â  Â  Â  Â  Â  placeBall(nx, ny);
Â  Â  Â  Â  };

Â  Â  Â  Â  const up = ev => {
Â  Â  Â  Â  Â  Â  if (ev.pointerId !== pid) return;
Â  Â  Â  Â  Â  Â  try { ball.releasePointerCapture(pid); } catch {}
Â  Â  Â  Â  Â  Â  document.removeEventListener('pointermove', move);
Â  Â  Â  Â  Â  Â  document.removeEventListener('pointerup', up);
Â  Â  Â  Â  Â  Â  isDraggingBall = false;
Â  Â  Â  Â  Â  Â  onDrop && onDrop();
Â  Â  Â  Â  };

Â  Â  Â  Â  document.addEventListener('pointermove', move, {passive: false});
Â  Â  Â  Â  document.addEventListener('pointerup', up, {passive: false});
Â  Â  };

Â  Â  if (ball) ball.addEventListener('pointerdown', down, {passive: false});
Â  Â  if (ball) ball.ondragstart = () => false;
}

function enableSelectionBox() {
Â  Â  if (userRole !== 'coach') return;
Â  Â Â 
Â  Â  let pid = null, startBoard = null, endBoard = null;
Â  Â Â 
Â  Â  const down = e => {
Â  Â  Â  Â  if (userRole !== 'coach' || isDraggingPlayer || isDraggingBall) return;
Â  Â  Â  Â  if (e.target.closest('.player') || e.target.closest('#ball')) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  pid = e.pointerId;Â 
Â  Â  Â  Â  board.setPointerCapture(pid);
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  startBoard = clientToBoard(e);
Â  Â  Â  Â  clearPlayerSelection(); // Inicia una nueva selecciÃ³n

Â  Â  Â  Â  if (selectionBox) {
Â  Â  Â  Â  Â  Â  selectionBox.style.left = startBoard.x + 'px';
Â  Â  Â  Â  Â  Â  selectionBox.style.top = startBoard.y + 'px';
Â  Â  Â  Â  Â  Â  selectionBox.style.width = '0';
Â  Â  Â  Â  Â  Â  selectionBox.style.height = '0';
Â  Â  Â  Â  Â  Â  selectionBox.style.display = 'block';
Â  Â  Â  Â  }

Â  Â  Â  Â  const move = ev => {
Â  Â  Â  Â  Â  Â  if (ev.pointerId !== pid || userRole !== 'coach') return;
Â  Â  Â  Â  Â  Â  ev.preventDefault();
Â  Â  Â  Â  Â  Â  endBoard = clientToBoard(ev);
Â  Â  Â  Â  Â  Â  const left = Math.min(startBoard.x, endBoard.x);
Â  Â  Â  Â  Â  Â  const top = Math.min(startBoard.y, endBoard.y);
Â  Â  Â  Â  Â  Â  const width = Math.abs(endBoard.x - startBoard.x);
Â  Â  Â  Â  Â  Â  const height = Math.abs(endBoard.y - startBoard.y);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (selectionBox) {
Â  Â  Â  Â  Â  Â  Â  Â  selectionBox.style.left = left + 'px';
Â  Â  Â  Â  Â  Â  Â  Â  selectionBox.style.top = top + 'px';
Â  Â  Â  Â  Â  Â  Â  Â  selectionBox.style.width = width + 'px';
Â  Â  Â  Â  Â  Â  Â  Â  selectionBox.style.height = height + 'px';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Highlight temporal de jugadores en la caja (opcional, pero ayuda al UX)
Â  Â  Â  Â  Â  Â  const tempRect = {left, top, right: left + width, bottom: top + height};
Â  Â  Â  Â  Â  Â  [...playersLayer.children].forEach(p => {
Â  Â  Â  Â  Â  Â  Â  Â  const isOverlapping = rectIntersect(getPlayerRect(p), tempRect);
Â  Â  Â  Â  Â  Â  Â  Â  if (isOverlapping && !p.classList.contains('selected')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  p.classList.add('selected');
Â  Â  Â  Â  Â  Â  Â  Â  } else if (!isOverlapping && p.classList.contains('selected') && !selectedPlayers.has(p)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  p.classList.remove('selected');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  };

Â  Â  Â  Â  const up = ev => {
Â  Â  Â  Â  Â  Â  if (ev.pointerId !== pid) return;
Â  Â  Â  Â  Â  Â  try { board.releasePointerCapture(pid); } catch {}
Â  Â  Â  Â  Â  Â  document.removeEventListener('pointermove', move);
Â  Â  Â  Â  Â  Â  document.removeEventListener('pointerup', up);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (selectionBox) selectionBox.style.display = 'none';

Â  Â  Â  Â  Â  Â  // LÃ³gica de selecciÃ³n final
Â  Â  Â  Â  Â  Â  if (startBoard && endBoard) {
Â  Â  Â  Â  Â  Â  Â  Â  const left = Math.min(startBoard.x, endBoard.x);
Â  Â  Â  Â  Â  Â  Â  Â  const top = Math.min(startBoard.y, endBoard.y);
Â  Â  Â  Â  Â  Â  Â  Â  const right = Math.max(startBoard.x, endBoard.x);
Â  Â  Â  Â  Â  Â  Â  Â  const bottom = Math.max(startBoard.y, endBoard.y);
Â  Â  Â  Â  Â  Â  Â  Â  const selectionRect = {left, top, right, bottom};
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Limpia selecciÃ³n previa (solo si no es un click sin arrastre)
Â  Â  Â  Â  Â  Â  Â  Â  if (Math.abs(startBoard.x - endBoard.x) > 5 || Math.abs(startBoard.y - endBoard.y) > 5) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearPlayerSelection(); // Lo limpiamos para evitar duplicados si ya estaba seleccionado
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  [...playersLayer.children].forEach(p => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (rectIntersect(getPlayerRect(p), selectionRect)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  p.classList.add('selected');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectedPlayers.add(p);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  p.classList.remove('selected');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Si es un click simple y no tocÃ³ jugador, deseleccionar todo
Â  Â  Â  Â  Â  Â  Â  Â  if (Math.abs(startBoard.x - endBoard.x) < 5 && Math.abs(startBoard.y - endBoard.y) < 5) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearPlayerSelection();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  document.addEventListener('pointermove', move, {passive: false});
Â  Â  Â  Â  document.addEventListener('pointerup', up, {passive: false});
Â  Â  };

Â  Â  if (board) board.addEventListener('pointerdown', down, {passive: false});
}

function clearPlayerSelection() {
Â  Â  selectedPlayers.forEach(el => el.classList.remove('selected'));
Â  Â  selectedPlayers.clear();
}


// ==================== EXPORTACIÃ“N (Implementadas) ====================

// FunciÃ³n auxiliar para forzar la descarga
function downloadFile(data, filename, type) {
Â  Â  const a = document.createElement('a');
Â  Â  a.href = data;
Â  Â  a.download = filename;
Â  Â  document.body.appendChild(a);
Â  Â  a.click();
Â  Â  document.body.removeChild(a);
}

// ExportaciÃ³n a imagen (JPG)
async function exportToImage(format = 'image/jpeg') {
Â  Â  if (!boardWrap) return;

Â  Â  showStatus('Generando imagen del tablero...', 'var(--warn)');
Â  Â Â 
Â  Â  try {
Â  Â  Â  Â  // html2canvas captura el DIV del tablero
Â  Â  Â  Â  const canvas = await html2canvas(boardWrap, {
Â  Â  Â  Â  Â  Â  useCORS: true,
Â  Â  Â  Â  Â  Â  logging: false,
Â  Â  Â  Â  Â  Â  width: WIDTH,
Â  Â  Â  Â  Â  Â  height: HEIGHT,
Â  Â  Â  Â  Â  Â  scale: 1,
Â  Â  Â  Â  Â  Â  // Evita que el contenedor del viewport aplique escalado/rotaciÃ³n
Â  Â  Â  Â  Â  Â  foreignObjectRendering: true,
Â  Â  Â  Â  Â  Â  allowTaint: true
Â  Â  Â  Â  });

Â  Â  Â  Â  const mimeType = format === 'image/jpeg' ? 'image/jpeg' : 'image/png';
Â  Â  Â  Â  const ext = format === 'image/jpeg' ? 'jpg' : 'png';
Â  Â  Â  Â  const dataURL = canvas.toDataURL(mimeType, 0.9);

Â  Â  Â  Â  downloadFile(dataURL, `rugbyboard-frame.${ext}`, mimeType);
Â  Â  Â  Â  showStatus('Imagen exportada correctamente', 'var(--accent2)');

Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Error al exportar imagen:', error);
Â  Â  Â  Â  showStatus('ERROR: No se pudo exportar la imagen. Revisa la consola.', 'var(--red)');
Â  Â  }
}


// ExportaciÃ³n a video (WebM/MP4)
async function recordVideo(format = 'webm') {
Â  Â  if (isRecordingVideo) {
Â  Â  Â  Â  showStatus('Ya estÃ¡ exportando un video.', 'var(--warn)');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  if (timeline.length < 2) {
Â  Â  Â  Â  showStatus('Necesitas al menos 2 pasos en la animaciÃ³n para exportar un video.', 'var(--red)');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const f = await loadFfmpeg();
Â  Â  if (!f) return;

Â  Â  isRecordingVideo = true;
Â  Â  showStatus(`Iniciando grabaciÃ³n para exportar a ${format.toUpperCase()}...`, 'var(--warn)');

Â  Â  // Limpiar antes de empezar
Â  Â  stopAnimation();
Â  Â  gotoFrame(0);
Â  Â Â 
Â  Â  const frameDuration = parseInt(speed.value, 10) || 800; // DuraciÃ³n de cada segmento
Â  Â  const totalFrames = timeline.length - 1;

Â  Â  // 1. Capturar todos los frames intermedios de la animaciÃ³n
Â  Â  const framePromises = [];
Â  Â  const captureInterval = frameDuration / FRAME_RATE; // Milisegundos por frame

Â  Â  try {
Â  Â  Â  Â  for (let i = 0; i < totalFrames; i++) {
Â  Â  Â  Â  Â  Â  const fromFrame = timeline[i];
Â  Â  Â  Â  Â  Â  const toFrame = timeline[i + 1];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Capturar la posiciÃ³n inicial
Â  Â  Â  Â  Â  Â  framePromises.push(captureCurrentFrame(fromFrame.players, fromFrame.ball, `${i}_00`));

Â  Â  Â  Â  Â  Â  // Capturar frames intermedios
Â  Â  Â  Â  Â  Â  const totalInterFrames = FRAME_RATE; // 20 FPS por segmento
Â  Â  Â  Â  Â  Â  for (let j = 1; j < totalInterFrames; j++) {
Â  Â  Â  Â  Â  Â  Â  Â  const t = j / totalInterFrames;
Â  Â  Â  Â  Â  Â  Â  Â  const frameName = `${i}_${String(j).padStart(2, '0')}`;
Â  Â  Â  Â  Â  Â  Â  Â  framePromises.push(captureInterpolatedFrame(fromFrame, toFrame, t, frameName));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  // Capturar la posiciÃ³n final
Â  Â  Â  Â  framePromises.push(captureCurrentFrame(timeline[totalFrames].players, timeline[totalFrames].ball, `${totalFrames}_00`));


Â  Â  Â  Â  showStatus('Renderizando frames de la animaciÃ³n...', 'var(--warn)');
Â  Â  Â  Â  await Promise.all(framePromises);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 2. Escribir frames en FFMPEG File System (Memoria)
Â  Â  Â  Â  showStatus('Preparando archivos de FFMPEG...', 'var(--warn)');
Â  Â  Â  Â  for (let i = 0; i <= totalFrames; i++) {
Â  Â  Â  Â  Â  Â  const totalInterFrames = i < totalFrames ? FRAME_RATE : 1; // 20 frames por segmento, excepto el Ãºltimo punto
Â  Â  Â  Â  Â  Â  for (let j = 0; j < totalInterFrames; j++) {
Â  Â  Â  Â  Â  Â  Â  Â  const frameName = `${i}_${String(j).padStart(2, '0')}.png`;
Â  Â  Â  Â  Â  Â  Â  Â  const dataUrl = localStorage.getItem(frameName);
Â  Â  Â  Â  Â  Â  Â  Â  if (dataUrl) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const buffer = base64ToUint8Array(dataUrl.split(',')[1]);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await f.writeFile(frameName, buffer);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem(frameName); // Limpiar almacenamiento temporal
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn(`Frame no encontrado en localStorage: ${frameName}`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  // Escribir lista de frames
Â  Â  Â  Â  const fileListContent = [];
Â  Â  Â  Â  for (let i = 0; i <= totalFrames; i++) {
Â  Â  Â  Â  Â  Â  const totalInterFrames = i < totalFrames ? FRAME_RATE : 1;
Â  Â  Â  Â  Â  Â  for (let j = 0; j < totalInterFrames; j++) {
Â  Â  Â  Â  Â  Â  Â  Â  fileListContent.push(`file '${i}_${String(j).padStart(2, '0')}.png'`);
Â  Â  Â  Â  Â  Â  Â  Â  // DuraciÃ³n del frame (1/FPS)
Â  Â  Â  Â  Â  Â  Â  Â  if (i < totalFrames || j < totalInterFrames - 1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fileListContent.push(`duration ${1 / FRAME_RATE}`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  await f.writeFile('input.txt', fileListContent.join('\n'));
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 3. Ejecutar FFMPEG
Â  Â  Â  Â  const outputName = `rugbyboard-play.${format}`;
Â  Â  Â  Â  const command = [
Â  Â  Â  Â  Â  Â  '-f', 'concat',
Â  Â  Â  Â  Â  Â  '-i', 'input.txt',
Â  Â  Â  Â  Â  Â  '-c:v', (format === 'mp4' ? 'libx264' : 'libvpx'),
Â  Â  Â  Â  Â  Â  '-pix_fmt', 'yuv420p',
Â  Â  Â  Â  Â  Â  '-r', FRAME_RATE,
Â  Â  Â  Â  Â  Â  outputName
Â  Â  Â  Â  ];
Â  Â  Â  Â Â 
Â  Â  Â  Â  showStatus(`Codificando video a ${format.toUpperCase()}...`, 'var(--warn)');
Â  Â  Â  Â  await f.exec(command);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 4. Descargar y limpiar
Â  Â  Â  Â  const data = await f.readFile(outputName);
Â  Â  Â  Â  const blob = new Blob([data.buffer], { type: format === 'mp4' ? 'video/mp4' : 'video/webm' });
Â  Â  Â  Â  const url = URL.createObjectURL(blob);
Â  Â  Â  Â  downloadFile(url, outputName, 'video/' + format);
Â  Â  Â  Â Â 
Â  Â  Â  Â  //f.unlink(outputName); // Limpia archivo de salida
Â  Â  Â  Â  showStatus(`Video ${format.toUpperCase()} exportado.`, 'var(--accent2)');

Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Error al exportar video:', error);
Â  Â  Â  Â  showStatus('ERROR: FallÃ³ la exportaciÃ³n de video. Revisa la consola.', 'var(--red)');
Â  Â  } finally {
Â  Â  Â  Â  isRecordingVideo = false;
Â  Â  Â  Â  // Vuelve al frame actual
Â  Â  Â  Â  gotoFrame(playIdx); 
Â  Â  }
}

// Auxiliar para la codificaciÃ³n
function base64ToUint8Array(base64) {
Â  Â  const binaryString = atob(base64);
Â  Â  const len = binaryString.length;
Â  Â  const bytes = new Uint8Array(len);
Â  Â  for (let i = 0; i < len; i++) {
Â  Â  Â  Â  bytes[i] = binaryString.charCodeAt(i);
Â  Â  }
Â  Â  return bytes;
}

// Captura un frame en el canvas de exportaciÃ³n
async function captureCurrentFrame(playersData, ballData, frameName) {
Â  Â  // 1. Aplicar posiciones al DOM
Â  Â  playersData.forEach(p => {
Â  Â  Â  Â  const el = [...playersLayer.children].find(e => e.dataset.team === p.team && +e.dataset.number === p.number);
Â  Â  Â  Â  if (el) { el.style.left = p.x + 'px'; el.style.top = p.y + 'px'; }
Â  Â  });
Â  Â  placeBall(ballData.x, ballData.y);
Â  Â  await new Promise(r => requestAnimationFrame(r)); // Espera un repaint
Â  Â Â 
Â  Â  // 2. Capturar con html2canvas
Â  Â  const canvas = await html2canvas(boardWrap, {
Â  Â  Â  Â  useCORS: true, logging: false, width: WIDTH, height: HEIGHT, scale: 1, foreignObjectRendering: true, allowTaint: true
Â  Â  });
Â  Â Â 
Â  Â  // 3. Almacenar temporalmente en localStorage (para simplificar el ejemplo)
Â  Â  const dataURL = canvas.toDataURL('image/png');
Â  Â  localStorage.setItem(`${frameName}.png`, dataURL);
}

// Captura un frame interpolado para la suavidad
async function captureInterpolatedFrame(fromF, toF, t, frameName) {
Â  Â  const interpolatedPlayers = fromF.players.map((p, i) => {
Â  Â  Â  Â  const target = toF.players.find(tp => tp.team === p.team && tp.number === p.number);
Â  Â  Â  Â  return target ? {
Â  Â  Â  Â  Â  Â  x: p.x + (target.x - p.x) * t,
Â  Â  Â  Â  Â  Â  y: p.y + (target.y - p.y) * t,
Â  Â  Â  Â  Â  Â  team: p.team, number: p.number
Â  Â  Â  Â  } : p;
Â  Â  });
Â  Â  const interpolatedBall = {
Â  Â  Â  Â  x: fromF.ball.x + (toF.ball.x - fromF.ball.x) * t,
Â  Â  Â  Â  y: fromF.ball.y + (toF.ball.y - fromF.ball.y) * t,
Â  Â  };

Â  Â  return captureCurrentFrame(interpolatedPlayers, interpolatedBall, frameName);
}


// ==================== ANIMACIÃ“N (Implementada) ====================

function animateFrame(timestamp) {
Â  Â  if (!playing) return;
Â  Â Â 
Â  Â  const duration = parseInt(speed.value, 10) || 800;

Â  Â  if (rafId === null) {
Â  Â  Â  Â  // Primera llamada o despuÃ©s de una pausa/stop
Â  Â  Â  Â  segStart = timestamp;
Â  Â  Â  Â  playIdx = parseInt(scrubber.value, 10);
Â  Â  Â  Â  if (playIdx >= timeline.length - 1) {
Â  Â  Â  Â  Â  Â  // Si estÃ¡ en el Ãºltimo frame, volver al inicio
Â  Â  Â  Â  Â  Â  playIdx = 0;
Â  Â  Â  Â  Â  Â  gotoFrame(playIdx);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  const elapsed = timestamp - segStart;
Â  Â  const t = clamp(elapsed / duration, 0, 1); // Progreso de 0 a 1 para interpolaciÃ³n
Â  Â Â 
Â  Â  if (timeline.length < 2) {
Â  Â  Â  Â  stopAnimation();
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const currentFrame = timeline[playIdx];
Â  Â  const nextFrame = timeline[playIdx + 1];

Â  Â  if (currentFrame && nextFrame) {
Â  Â  Â  Â  // InterpolaciÃ³n de jugadores
Â  Â  Â  Â  currentFrame.players.forEach(p => {
Â  Â  Â  Â  Â  Â  const target = nextFrame.players.find(tp => tp.team === p.team && tp.number === p.number);
Â  Â  Â  Â  Â  Â  if (target) {
Â  Â  Â  Â  Â  Â  Â  Â  const el = [...playersLayer.children].find(e => e.dataset.team === p.team && +e.dataset.number === p.number);
Â  Â  Â  Â  Â  Â  Â  Â  if (el) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  el.style.left = p.x + (target.x - p.x) * t + 'px';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  el.style.top = p.y + (target.y - p.y) * t + 'px';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // InterpolaciÃ³n del balÃ³n
Â  Â  Â  Â  placeBall(
Â  Â  Â  Â  Â  Â  currentFrame.ball.x + (nextFrame.ball.x - currentFrame.ball.x) * t,
Â  Â  Â  Â  Â  Â  currentFrame.ball.y + (nextFrame.ball.y - currentFrame.ball.y) * t
Â  Â  Â  Â  );

Â  Â  Â  Â  // Actualizar scrubber al frame actual
Â  Â  Â  Â  const currentScrubValue = playIdx + t;
Â  Â  Â  Â  scrubber.value = currentScrubValue;
Â  Â  Â  Â  scrubLbl.textContent=`${playIdx}/${timeline.length-1}`;

Â  Â  Â  Â  // Avanzar al siguiente frame
Â  Â  Â  Â  if (t >= 1) {
Â  Â  Â  Â  Â  Â  playIdx++;
Â  Â  Â  Â  Â  Â  segStart = timestamp; // Reiniciar temporizador
Â  Â  Â  Â  Â  Â  // Si se completÃ³ la animaciÃ³n, detener o repetir
Â  Â  Â  Â  Â  Â  if (playIdx >= timeline.length - 1) {
Â  Â  Â  Â  Â  Â  Â  Â  stopAnimation();
Â  Â  Â  Â  Â  Â  Â  Â  gotoFrame(timeline.length - 1);
Â  Â  Â  Â  Â  Â  Â  Â  showStatus('AnimaciÃ³n finalizada', 'var(--accent)');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  }

Â  Â  rafId = requestAnimationFrame(animateFrame);
}

function startAnimation() {
Â  Â  if (timeline.length < 2) {
Â  Â  Â  Â  showStatus('Necesitas al menos 2 pasos grabados.', 'var(--red)');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  if (playing) return;
Â  Â Â 
Â  Â  // Si ya estÃ¡ al final, empezar de nuevo
Â  Â  playIdx = parseInt(scrubber.value, 10) >= timeline.length - 1 ? 0 : parseInt(scrubber.value, 10);
Â  Â  gotoFrame(playIdx); // Asegurar que la posiciÃ³n inicial sea la del frame de inicio
Â  Â Â 
Â  Â  playing = true;
Â  Â  btnPlayPause.textContent = 'Pausa';
Â  Â  rafId = requestAnimationFrame(animateFrame);
}

function stopAnimation() {
Â  Â  if (rafId) cancelAnimationFrame(rafId);
Â  Â  playing = false;
Â  Â  rafId = null;
Â  Â  segStart = 0;
Â  Â  btnPlayPause.textContent = 'Reproducir';
}


// ==================== INICIALIZACIÃ“N ====================

// (Mantenido y adaptado para llamar a las nuevas funciones)

document.addEventListener('DOMContentLoaded', function() {
Â  Â  assignDOMElements();
Â  Â Â 
Â  Â  // Configurar event listeners
Â  Â  if (btnAuthAction) {
Â  Â  Â  Â  btnAuthAction.addEventListener('click', function() {
Â  Â  Â  Â  Â  Â  if (isAuthorized) {
Â  Â  Â  Â  Â  Â  Â  Â  handleLogout();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  openLoginModal();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }
Â  Â Â 
Â  Â  if (btnLogin) { btnLogin.addEventListener('click', handleLogin); }
Â  Â  if (btnCloseLogin) { btnCloseLogin.addEventListener('click', closeLoginModal); }

Â  Â  if (btnInvitePlayer && playerEmail) {
Â  Â  Â  Â  btnInvitePlayer.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  invitePlayer(playerEmail.value);
Â  Â  Â  Â  });
Â  Â  }

Â  Â  if (btnSavePlay) {
Â  Â  Â  Â  btnSavePlay.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  const name = (playName.value || '').trim();
Â  Â  Â  Â  Â  Â  if (!name) {
Â  Â  Â  Â  Â  Â  Â  Â  showStatus('Ingresa un nombre para la jugada', 'var(--warn)');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  savePlay(name);
Â  Â  Â  Â  });
Â  Â  }

Â  Â  if (btnLoadPlay) {
Â  Â  Â  Â  btnLoadPlay.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  if (!playList.value) {
Â  Â  Â  Â  Â  Â  Â  Â  showStatus('Selecciona una jugada', 'var(--warn)');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  loadPlay(playList.value);
Â  Â  Â  Â  });
Â  Â  }
Â  Â Â 
Â  Â  // **CLONAR JUGADA (DUPLICAR) - Nuevo Evento**
Â  Â  if (btnDuplicate) {
Â  Â  Â  Â  btnDuplicate.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  const oldName = (playName.value || 'Nueva Jugada').trim();
Â  Â  Â  Â  Â  Â  const newName = prompt(`Duplicar: Ingresa el nuevo nombre (Actual: ${oldName})`, `${oldName} (Copia)`);
Â  Â  Â  Â  Â  Â  if (newName && newName.trim()) {
Â  Â  Â  Â  Â  Â  Â  Â  savePlay(newName.trim());
Â  Â  Â  Â  Â  Â  Â  Â  playName.value = newName.trim();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }


Â  Â  if (btnDelete) {
Â  Â  Â  Â  btnDelete.addEventListener('click', async () => {
Â  Â  Â  Â  Â  Â  if (!playList.value) {
Â  Â  Â  Â  Â  Â  Â  Â  showStatus('Selecciona una jugada para eliminar', 'var(--warn)');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!confirm(`Â¿EstÃ¡s seguro de eliminar la jugada: ${playList.options[playList.selectedIndex].textContent}?`)) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await window.firestore.deleteDoc(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.firestore.doc(getCoachPlaysCollectionRef(), playList.value)
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  showStatus('Jugada eliminada', 'var(--accent)');
Â  Â  Â  Â  Â  Â  Â  Â  playName.value = ''; // Limpiar campo de nombre
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error eliminando jugada:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showStatus('Error al eliminar jugada', 'var(--red)');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // Eventos de exportaciÃ³n
Â  Â  if (btnExportJpg) { btnExportJpg.addEventListener('click', () => exportToImage('image/jpeg')); }
Â  Â  if (btnExportWebm) { btnExportWebm.addEventListener('click', () => recordVideo('webm')); }
Â  Â  if (btnExportMp4) { btnExportMp4.addEventListener('click', () => recordVideo('mp4')); }


Â  Â  // Eventos de timeline
Â  Â  if (btnRecord) {
Â  Â  Â  Â  btnRecord.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  recordFrame();
Â  Â  Â  Â  Â  Â  showStatus('Paso grabado', 'var(--accent2)');
Â  Â  Â  Â  });
Â  Â  }

Â  Â  if (scrubber) {
Â  Â  Â  Â  scrubber.addEventListener('input', (e) => {
Â  Â  Â  Â  Â  Â  // Detener animaciÃ³n y saltar al frame
Â  Â  Â  Â  Â  Â  stopAnimation();
Â  Â  Â  Â  Â  Â  gotoFrame(parseInt(e.target.value, 10));
Â  Â  Â  Â  });
Â  Â  }

Â  Â  if (btnPlayPause) {
Â  Â  Â  Â  btnPlayPause.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  if (playing) {
Â  Â  Â  Â  Â  Â  Â  Â  stopAnimation(); // Pausa
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  startAnimation(); // Reproducir/Continuar
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  if (btnStop) {
Â  Â  Â  Â  btnStop.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  stopAnimation();
Â  Â  Â  Â  Â  Â  gotoFrame(0);
Â  Â  Â  Â  });
Â  Â  }
Â  Â Â 
Â  Â  if (btnClrTl) {
Â  Â  Â  Â  btnClrTl.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  if (confirm('Â¿Limpiar toda la animaciÃ³n? Se conservarÃ¡n jugadores y dibujos.')) {
Â  Â  Â  Â  Â  Â  Â  Â  stopAnimation();
Â  Â  Â  Â  Â  Â  Â  Â  timeline = [];
Â  Â  Â  Â  Â  Â  Â  Â  recordFrame(); // Deja el estado actual como Frame 0
Â  Â  Â  Â  Â  Â  Â  Â  showStatus('AnimaciÃ³n limpiada', 'var(--accent)');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }


Â  Â  if (btnReset) {
Â  Â  Â  Â  btnReset.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  if (confirm('Â¿Reiniciar tablero? Se perderÃ¡n los cambios no guardados.')) {
Â  Â  Â  Â  Â  Â  Â  Â  stopAnimation();
Â  Â  Â  Â  Â  Â  Â  Â  createPlayers();
Â  Â  Â  Â  Â  Â  Â  Â  placeBall();
Â  Â  Â  Â  Â  Â  Â  Â  arrows = [];
Â  Â  Â  Â  Â  Â  Â  Â  strokes = [];
Â  Â  Â  Â  Â  Â  Â  Â  notes = [];
Â  Â  Â  Â  Â  Â  Â  Â  timeline = [];
Â  Â  Â  Â  Â  Â  Â  Â  recordFrame();
Â  Â  Â  Â  Â  Â  Â  Â  renderDraw();
Â  Â  Â  Â  Â  Â  Â  Â  showStatus('Tablero reiniciado', 'var(--accent)');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }
Â  Â Â 
Â  Â  // Eventos de menÃº mÃ³vil
Â  Â  if (btnMenuOpen) btnMenuOpen.addEventListener('click', openMobileMenu);
Â  Â  if (btnCloseMenu) btnCloseMenu.addEventListener('click', closeMobileMenu);
Â  Â  if (menuOverlay) menuOverlay.addEventListener('click', closeMobileMenu);
Â  Â Â 
Â  Â  // Eventos de orientaciÃ³n
Â  Â  if (btnLandscape) btnLandscape.addEventListener('click', ()=>{Â 
Â  Â  Â  Â  forcePortrait=false;Â 
Â  Â  Â  Â  setSegActive(btnLandscape,btnPortrait);Â 
Â  Â  Â  Â  fitBoard();Â 
Â  Â  Â  Â  closeMobileMenu();Â 
Â  Â  });
Â  Â Â 
Â  Â  if (btnPortrait) btnPortrait.addEventListener('click', ()=>{Â 
Â  Â  Â  Â  forcePortrait=true;Â 
Â  Â  Â  Â  setSegActive(btnPortrait,btnLandscape);Â 
Â  Â  Â  Â  fitBoard();Â 
Â  Â  Â  Â  closeMobileMenu();Â 
Â  Â  });

Â  Â  // Eventos de ventana
Â  Â  window.addEventListener('resize', fitBoard);
Â  Â  window.addEventListener('orientationchange', fitBoard);
Â  Â Â 
Â  Â  // Inicializar aplicaciÃ³n
Â  Â  initBoardApp();
});

// ==================== FUNCIONES DEL TABLERO (Mantenidas y adaptadas) ====================

function initBoardApp(){
Â  Â  console.log("Inicializando aplicaciÃ³n...");
Â  Â Â 
Â  Â  // Crear jugadores y balÃ³n
Â  Â  createPlayers();
Â  Â  placeBall();
Â  Â Â 
Â  Â  // Timeline inicial
Â  Â  if (!timeline.length) { recordFrame(); }
Â  Â  updateScrub();

Â  Â  // Inicializar estado de auth
Â  Â  if (window.firebaseOnAuthStateChanged) {
Â  Â  Â  Â  window.firebaseOnAuthStateChanged(window.firebaseAuth, async (user) => {
Â  Â  Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  Â  Â  currentUser = user;
Â  Â  Â  Â  Â  Â  Â  Â  isAuthorized = true;
Â  Â  Â  Â  Â  Â  Â  Â  await determineUserRole();
Â  Â  Â  Â  Â  Â  Â  Â  refreshPlayList();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  currentUser = null;
Â  Â  Â  Â  Â  Â  Â  Â  isAuthorized = false;
Â  Â  Â  Â  Â  Â  Â  Â  userRole = 'spectator';
Â  Â  Â  Â  Â  Â  Â  Â  currentCoachId = null;
Â  Â  Â  Â  Â  Â  Â  Â  if (unsubscribePlays) { unsubscribePlays(); unsubscribePlays = null; }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  updateAuthUI();
Â  Â  Â  Â  Â  Â  reInitializePlayerInteractions(); // Importante para activar/desactivar drag
Â  Â  Â  Â  });
Â  Â  } else {
Â  Â  Â  Â  reInitializePlayerInteractions();
Â  Â  }

Â  Â  // UI inicial
Â  Â  if (showGrid) {
Â  Â  Â  Â  showGrid.addEventListener('change', renderGrid);
Â  Â  Â  Â  showGrid.checked = false;
Â  Â  }
Â  Â  renderGrid();
Â  Â  renderDraw();
Â  Â  fitBoard();
Â  Â  setTimeout(fitBoard, 50);
Â  Â Â 
Â  Â  // Precarga de FFMPEG (opcional, para ser mÃ¡s rÃ¡pido)
Â  Â  loadFfmpeg(); 
}

function createPlayers() {
Â  Â  if (!playersLayer) return;
Â  Â  playersLayer.innerHTML='';
Â  Â  selectedPlayers.clear();
Â  Â  initialPositions.forEach(p=>{
Â  Â  Â  Â  const el=document.createElement('div');
Â  Â  Â  Â  const teamData = p.team === 'team-1' ? teamConfig.team1 : teamConfig.team2;
Â  Â  Â  Â  el.className=`player ${teamData.colorClass}`;Â 
Â  Â  Â  Â  el.textContent = p.number;
Â  Â  Â  Â  el.dataset.team = p.team;Â 
Â  Â  Â  Â  el.dataset.number = p.number;
Â  Â  Â  Â  el.style.left = p.x+'px'; el.style.top = p.y+'px';
Â  Â  Â  Â  playersLayer.appendChild(el);
Â  Â  });
Â  Â  applyUprightTransforms();
}

function placeBall(x=WIDTH/2,y=HEIGHT/2){
Â  Â  if (!ball) return;
Â  Â  currentBallPos.x=x; currentBallPos.y=y;
Â  Â  ball.style.left=x+'px'; ball.style.top=y+'px';
Â  Â  ball.style.transform='translate(-50%,-50%) rotate(-15deg)';
}

// Funciones de coordenadas (sin cambios)
function clientToBoard(e){
Â  Â  if (!boardViewport) return {x:0, y:0};
Â  Â  const vp=boardViewport.getBoundingClientRect();
Â  Â  const cx=e.clientX - vp.left;
Â  Â  const cy=e.clientY - vp.top;
Â  Â Â 
Â  Â  if (layout.mode==='portrait'){
Â  Â  Â  Â  const centerX = vp.width / 2;
Â  Â  Â  Â  const centerY = vp.height / 2;
Â  Â  Â  Â  const px = cx - centerX;
Â  Â  Â  Â  const py = cy - centerY;
Â  Â  Â  Â  const x_board_scaled = py;
Â  Â  Â  Â  const y_board_scaled = -px;
Â  Â  Â  Â  const x_board = (WIDTH / 2) + (x_board_scaled / layout.scale);
Â  Â  Â  Â  const y_board = (HEIGHT / 2) + (y_board_scaled / layout.scale);
Â  Â  Â  Â  return { x:clamp(x_board,0,WIDTH), y:clamp(y_board,0,HEIGHT) };
Â  Â  } else {
Â  Â  Â  Â  const scaledW = WIDTH * layout.scale;
Â  Â  Â  Â  const scaledH = HEIGHT * layout.scale;
Â  Â  Â  Â  const x = (cx - (vp.width - scaledW) / 2) / layout.scale;
Â  Â  Â  Â  const y = (cy - (vp.height - scaledH) / 2) / layout.scale;
Â  Â  Â  Â  return { x:clamp(x,0,WIDTH), y:clamp(y,0,HEIGHT) };
Â  Â  }
}

function deltaToBoard(dxClient, dyClient){
Â  Â  if (layout.mode==='portrait'){
Â  Â  Â  Â  return {Â 
Â  Â  Â  Â  Â  Â  dx: dyClient / layout.scale,Â Â 
Â  Â  Â  Â  Â  Â  dy: -dxClient / layout.scaleÂ 
Â  Â  Â  Â  };
Â  Â  }else{
Â  Â  Â  Â  return { dx: dxClient / layout.scale, dy: dyClient / layout.scale };
Â  Â  }
}

function fitBoard(){
Â  Â  if (!boardViewport || !boardWrap) return;
Â  Â Â 
Â  Â  const vp=boardViewport.getBoundingClientRect();
Â  Â  const availW=vp.width, availH=vp.height;

Â  Â  const baseW = WIDTH;
Â  Â  const baseH = HEIGHT;

Â  Â  let currentW, currentH;
Â  Â  let scale;

Â  Â  const isMobile = window.innerWidth <= 999;
Â  Â Â 
Â  Â  if (isMobile) {
Â  Â  Â  Â  forcePortrait = true;Â 
Â  Â  }
Â  Â Â 
Â  Â  if (forcePortrait || isMobile){
Â  Â  Â  Â  layout.mode='portrait';
Â  Â  Â  Â  currentW = baseH;
Â  Â  Â  Â  currentH = baseW;
Â  Â  Â  Â  scale = Math.min(availW/currentW, availH/currentH);
Â  Â  Â  Â  layout.scale=scale;
Â  Â  Â  Â  boardWrap.style.transform=`rotate(90deg) scale(${scale})`;
Â  Â  Â  Â  boardWrap.style.transformOrigin='center center';
Â  Â  Â  Â Â 
Â  Â  Â  Â  const scaledRotatedW = baseH * scale;
Â  Â  Â  Â  const scaledRotatedH = baseW * scale;
Â  Â  Â  Â  layout.tx = (availW - scaledRotatedW) / 2;
Â  Â  Â  Â  layout.ty = (availH - scaledRotatedH) / 2;

Â  Â  Â  Â  if (btnPortrait) setSegActive(btnPortrait, btnLandscape);
Â  Â  Â  Â Â 
Â  Â  } else {
Â  Â  Â  Â  layout.mode='landscape';
Â  Â  Â  Â  currentW = baseW;
Â  Â  Â  Â  currentH = baseH;
Â  Â  Â  Â  scale = Math.min(availW/currentW, availH/currentH);
Â  Â  Â  Â  layout.scale=scale;
Â  Â  Â  Â  layout.tx = (availW - currentW * scale) / 2;
Â  Â  Â  Â  layout.ty = (availH - currentH * scale) / 2;
Â  Â  Â  Â  boardWrap.style.transform=`scale(${scale})`;
Â  Â  Â  Â  boardWrap.style.transformOrigin='center center';
Â  Â  Â  Â  if (btnLandscape) setSegActive(btnLandscape, btnPortrait);
Â  Â  }

Â  Â  applyUprightTransforms();
}

function applyUprightTransforms(){
Â  Â  const rotatePlayers=(layout.mode==='portrait');
Â  Â  if (!playersLayer) return;
Â  Â  [...playersLayer.children].forEach(el=>{
Â  Â  Â  Â  el.style.transform = rotatePlayers
Â  Â  Â  Â  Â  Â  ? 'translate(-50%,-50%) rotate(-90deg)'Â 
Â  Â  Â  Â  Â  Â  : 'translate(-50%,-50%)';
Â  Â  });
}

function setSegActive(segBtn, otherBtn){
Â  Â  if(segBtn) segBtn.classList.add('active');
Â  Â  if(otherBtn) otherBtn.classList.remove('active');
}

function recordFrame(){Â 
Â  Â  stopAnimation(); // Detener la reproducciÃ³n al grabar
Â  Â Â 
Â  Â  // Si estamos en medio de una animaciÃ³n (frame interpolado), borrar el resto
Â  Â  if (playIdx < timeline.length - 1) {
Â  Â  Â  Â  timeline.splice(playIdx + 1);
Â  Â  }
Â  Â Â 
Â  Â  timeline.push(snapshotFrame());Â 
Â  Â  playIdx = timeline.length - 1; // Mover el scrubber al nuevo frame
Â  Â  updateScrub();Â 
Â  Â  if(scrubber) scrubber.value = playIdx;
Â  Â  if(scrubLbl) scrubLbl.textContent=`${playIdx}/${timeline.length-1}`;
}

function updateScrub(){
Â  Â  if (!scrubber || !scrubLbl) return;
Â  Â  scrubber.max = Math.max(0, timeline.length - 1);
Â  Â  scrubLbl.textContent = `${scrubber.value}/${scrubber.max}`;
}

function gotoFrame(i){
Â  Â  if (!timeline.length) return;
Â  Â  i=Math.max(0,Math.min(timeline.length-1,i));
Â  Â  playIdx = i;
Â  Â Â 
Â  Â  // Sincronizar el valor del scrubber
Â  Â  if(scrubber) scrubber.value = i;
Â  Â  if(scrubLbl) scrubLbl.textContent=`${i}/${timeline.length-1}`;
Â  Â Â 
Â  Â  const f=timeline[i];
Â  Â  if (playersLayer) f.players.forEach(p=>{
Â  Â  Â  Â  const el=[...playersLayer.children].find(e=>e.dataset.team===p.team && +e.dataset.number===p.number);
Â  Â  Â  Â  if (el){ el.style.left=p.x+'px'; el.style.top=p.y+'px'; }
Â  Â  });
Â  Â  if (f.ball){ placeBall(f.ball.x, f.ball.y); }
Â  Â  clearPlayerSelection();
}

// Funciones mÃ³viles
function openMobileMenu() {
Â  Â  if(desktopSidepanel) desktopSidepanel.classList.add('open');
Â  Â  if(menuOverlay) menuOverlay.classList.add('open');
}

function closeMobileMenu() {
Â  Â  if(desktopSidepanel) desktopSidepanel.classList.remove('open');
Â  Â  if(menuOverlay) menuOverlay.classList.remove('open');
}

function reInitializePlayerInteractions() {
Â  Â  if (!playersLayer || !ball) return;
Â  Â Â 
Â  Â  // Re-habilita el arrastre en todos los elementos que ya existen
Â  Â  [...playersLayer.children].forEach(el => {
Â  Â  Â  Â  // Eliminar listeners previos para evitar duplicados
Â  Â  Â  Â  const newEl = el.cloneNode(true);
Â  Â  Â  Â  el.parentNode.replaceChild(newEl, el);
Â  Â  Â  Â  enableDragPlayer(newEl, () => {Â 
Â  Â  Â  Â  Â  Â  if (autoRec && autoRec.checked) recordFrame();Â 
Â  Â  Â  Â  });
Â  Â  });
Â  Â Â 
Â  Â  // Re-asigna la capa de jugadores a la variable global despuÃ©s del reemplazo
Â  Â  playersLayer = document.getElementById('players');
Â  Â Â 
Â  Â  // Habilitar arrastre de balÃ³n
Â  Â  enableDragBall(() => {Â 
Â  Â  Â  Â  if (autoRec && autoRec.checked) recordFrame();Â 
Â  Â  });
Â  Â Â 
Â  Â  // Habilitar selecciÃ³n masiva
Â  Â  enableSelectionBox();
Â  Â Â 
Â  Â  // Habilitar herramientas de dibujo
Â  Â  initDrawingTools();

Â  Â  // Aplica las transformaciones si hubo cambio de orientaciÃ³n
Â  Â  applyUprightTransforms();
}

</script>
</body>
</html>
