<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>RugbyBoard Pro — Bologna Rugby Club</title>
<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/umd/ffmpeg.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQODhPcO4/S/IpicFiGWcI4eXhF1G6h/ulD81Yj0L+O0BFCJAEInInKpTXy/x/YpB9PjS/fZy8f/K7t6h/a==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<style>
  :root{
    --bg:#0b1520; --panel:#0e1c2a; --panel2:#122235; --ink:#e8eef5; --muted:#9fb3c8;
    --border:#1b3147; --accent:#00c2ff; --accent2:#7ef29a; --warn:#ffd400; --red:#ff5a6b; --blue:#2f80ff;
    --shadow:0 8px 28px rgba(0,0,0,.35);
    --r:12px;
  }
  *{box-sizing:border-box}
  /* APLICAMOS EL FONDO OSCURO Y COLOR DE TEXTO GLOBALMENTE */
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .app{display:grid;grid-template-rows:auto 1fr;min-height:100dvh}

  /* Top bar */
  .topbar{display:flex;align-items:center;gap:12px;padding:10px 14px;background:linear-gradient(180deg,#0f2235,#0c1a29);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
  .brand{display:flex;align-items:center;gap:10px;font-weight:700}
  .brand .dot{width:12px;height:12px;border-radius:50%;background:var(--accent)}
  .toolbar{display:flex;gap:8px;margin-left:auto;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid var(--border);background:#122538;color:var(--ink);padding:.55rem .8rem;border-radius:10px;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn.primary{background:#0f2a3f;border-color:#22445f}
  .seg{display:flex;border:1px solid var(--border);border-radius:10px;overflow:hidden}
  .seg button{border:none;background:#13293d;padding:.45rem .7rem;color:var(--ink);cursor:pointer}
  .seg button.active{background:#15354f;color:#7fe7ff}

  /* Stage */
  .stage{position:relative;display:grid;grid-template-columns: 1fr;grid-template-rows:1fr;min-height:100%; padding: 0;}
  
  .board-viewport{
    position:relative;
    inset:0;
    display:flex;
    justify-content: center;
    align-items: center;
    overflow:hidden;
    width: 100%;
    height: 100%;
  }
  
  .board-wrap{position:relative; width:1200px; height:700px; transform-origin:center center;}  
  /* CAMPO DE JUEGO VERDE OSCURO */
  .board{position:absolute;inset:0;background:#137a46;border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
  .lines, .draw{position:absolute;inset:0;pointer-events:none}
  svg{width:100%;height:100%;display:block}
  .grid{position:absolute;inset:0;pointer-events:none;opacity:.55;display:none}
  .grid.on{display:block}

  /* Players & ball */
  #players{position:absolute;inset:0;z-index:3;pointer-events:none}
  .player{pointer-events:auto;position:absolute;width:40px;height:40px;border-radius:50%;display:grid;place-items:center;font-weight:800;font-size:14px;color:#fff;border:2px solid #fff;box-shadow:0 4px 16px rgba(0,0,0,.3);cursor:grab; transform: translate(-50%, -50%);}
  .player.selected{border: 3px solid var(--accent); box-shadow: 0 0 10px var(--accent);}
  .blue{background:var(--blue)} .red{background:var(--red)}
  .team-1{background:var(--blue);} .team-2{background:var(--red);}
  
  #ball{position:absolute;z-index:4}
  .ball{width:50px;height:30px;background:var(--warn);border:2px solid #fff;border-radius:50%/60%;transform:translate(-50%,-50%) rotate(-15deg);box-shadow:0 3px 12px rgba(0,0,0,.35);cursor:grab}
  .ball::after{content:"";position:absolute;inset:6px 18px;border-radius:50%/60%;border:2px dashed rgba(0,0,0,.25)}
  
  /* Selection Box */
  #selectionBox{
      position: absolute;
      pointer-events: none;
      border: 1px dashed var(--accent);
      background: rgba(0, 194, 255, 0.1);
      z-index: 5;
      display: none;
  }

  /* Modal Login */
  .modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: rgba(0, 0, 0, 0.7);
    display: none;
    place-items: center;
    z-index: 1000;
  }
  .modal-content {
    background-color: var(--panel);
    padding: 24px;
    border-radius: 12px;
    box-shadow: var(--shadow);
    width: 90%;
    max-width: 400px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    border: 1px solid var(--border);
  }
  .modal-content input {
    width: 100%;
    padding: 10px;
    background: var(--bg);
    color: var(--ink);
    border: 1px solid var(--border);
    border-radius: 8px;
  }
  .modal-content button {
    margin-top: 10px;
  }

  /* Desktop Styles */
  @media (min-width: 1000px){
    .app{grid-template-rows:auto 1fr}
    .stage{
        grid-template-columns: 320px 1fr;
        gap:14px;  
        padding:12px;  
        display: grid;  
        min-height: calc(100dvh - 70px);  
    }
    
    .sidepanel{
        position: relative;
        background:var(--panel);
        border:1px solid var(--border);
        border-radius:12px;
        padding:12px;
        display:flex;  
        flex-direction:column;
        gap:12px;  
        min-height: 100%;  
        overflow-y: auto;  
        transform: translateX(0) !important;
    }
    
    .dock, #btnMenuOpen { display: none !important; }
    
    .sidepanel-section { padding-top: 0 !important; border-top: none !important; }
    .sidepanel-section + .sidepanel-section { border-top: 1px solid var(--border) !important; padding-top: 12px !important; }
  }

  /* Mobile Styles */
  @media (max-width: 999px) {
    .app {  
        min-height: 100dvh;  
        grid-template-rows: auto 1fr;  
    }
    
    .stage {
        padding: 0;  
        min-height: auto;
        height: 100%;  
    }
    .board-viewport {
        width: 100%;
        height: 100%;
    }
    
    .topbar .seg, .topbar .toolbar > .btn { display: none; }
    .topbar #btnAuthAction, .topbar #btnMenuOpen { display: flex; }

    .sidepanel {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: 100%;
        max-width: 100vw;
        z-index: 1000;
        background: var(--bg);
        transform: translateX(-100%);
        transition: transform 0.3s ease-out;
        box-shadow: 4px 0 10px rgba(0,0,0,0.5);
        padding-top: 60px;
        display: flex;
        flex-direction: column;
    }
    
    .sidepanel.open {
        transform: translateX(0);
    }
    
    .dock { display: none !important; }
    
    #menuOverlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
    }
    #menuOverlay.open {
        display: block;
    }
  }

  /* Menu header */
  #menuHeader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      z-index: 1001;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      display: none;
      align-items: center;
      justify-content: space-between;
      padding: 0 14px;
  }
  .sidepanel.open ~ #menuHeader {
      display: flex;
  }

  .icon-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    color: var(--ink);
    display: flex;
    align-items: center;
  }
  .icon-btn svg {
    width: 24px;
    height: 24px;
  }
  #btnMenuOpen {
      display: none;
  }
  @media (max-width: 999px) {
      #btnMenuOpen {
          display: inline-block;
      }
  }

  /* Form elements */
  .field{display:flex;align-items:center;gap:8px;background:#0f2032;border:1px solid var(--border);border-radius:10px;padding:.5rem .6rem}
  .field label{font-size:.85rem;color:var(--muted)}
  select,input[type="number"],input[type="text"]{background:#0c1c2b;color:var(--ink);border:1px solid var(--border);border-radius:8px;padding:.45rem .55rem}
  input[type="checkbox"]{width:18px;height:18px}
  .grow{flex:1}
  .subtle{color:var(--muted);font-size:.85rem}
  .row{display:flex;flex-wrap:wrap;gap:8px}

</style>
</head>
<body>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, deleteDoc, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyACU3QfuTpW6PNRt3hHl9m1dy4Vso0GPoI",
      authDomain: "bologna-rugby-club.firebaseapp.com",
      projectId: "bologna-rugby-club",
      storageBucket: "bologna-rugby-club.appspot.com",
      messagingSenderId: "641438144435",
      appId: "1:641438144435:web:e2a243bacd522fd1615dc6",
      measurementId: "G-9C66KXJ561"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Exponer Firebase al ámbito global
    window.firebaseApp = app;
    window.firebaseAuth = auth;
    window.firebaseDb = db;
    window.firebaseSignIn = signInWithEmailAndPassword;
    window.firebaseSignOut = signOut;
    window.firebaseOnAuthStateChanged = onAuthStateChanged;
    
    // Funciones de Firestore
    window.firestore = {
      doc, setDoc, deleteDoc, collection, query, onSnapshot
    };

    console.log("Firebase inicializado correctamente");
</script>


    <div id="menuOverlay"></div>

    <div class="modal-overlay" id="loginModal">
        <div class="modal-content">
            <h3 style="font-weight:700; color:var(--accent);">Acceso Bologna Rugby Club</h3>
            <p class="subtle">Ingresa tus credenciales para acceder al tablero.</p>
            
            <input type="email" id="loginEmail" placeholder="Email"/>
            <input type="password" id="loginPassword" placeholder="Contraseña"/>
            
            <button class="btn primary" id="btnLogin">Iniciar Sesión</button>
            <p id="loginMessage" style="color:var(--red); font-size:0.85rem; margin:0;"></p>
            <button class="btn" id="btnCloseLogin">Cerrar</button>
        </div>
    </div>
    
    <div id="menuHeader">
        <span class="brand" style="font-size: 1.1rem;"><span class="dot"></span>Controles</span>
        <button class="icon-btn" id="btnCloseMenu">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
        </button>
    </div>

    <div class="app">
        <header class="topbar">
            <div class="brand" id="brand"><span class="dot"></span>Bologna Rugby Club - RugbyBoard</div>

            <div class="toolbar">
                <button class="btn primary" id="btnAuthAction">Iniciar Sesión</button>
                <button class="icon-btn" id="btnMenuOpen">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </button>
            </div>
        </header>

        <main class="stage">
        
            <aside class="sidepanel" id="desktopSidepanel">
            
                <div id="playerManagementSection" class="sidepanel-section" style="display:none; flex-direction:column; gap:10px;">
                    <h3 style="font-weight:700; font-size:1.1rem; color:var(--accent);">Gestionar Jugadores</h3>
                    <div class="field grow">
                        <input type="email" id="playerEmail" placeholder="Email del jugador" class="grow"/>
                    </div>
                    <div class="row">
                        <button class="btn grow" id="btnInvitePlayer">Invitar Jugador</button>
                    </div>
                    <p class="subtle">Los jugadores invitados podrán ver tus jugadas.</p>
                </div>

                <div id="orientationControls" class="sidepanel-section" style="display:flex; flex-direction:column; gap:10px;">
                    <h3 style="font-weight:700; font-size:1.1rem; color:var(--accent);">Orientación</h3>
                    <div class="seg" style="margin-top: 5px;">
                        <button id="btnLandscape" class="active" title="Horizontal">Horizontal</button>
                        <button id="btnPortrait" title="Vertical">Vertical</button>
                    </div>
                </div>

                <div id="exportUtilitiesSection" class="sidepanel-section" style="display:flex; flex-direction:column; gap:10px;">
                    <h3 style="font-weight:700; font-size:1.1rem; color:var(--accent);">Exportación</h3>
                    <div class="row">
                        <button class="btn grow" id="btnExportJpg">JPG</button>
                        <button class="btn grow" id="btnExportWebm">WebM</button>
                        <button class="btn grow" id="btnExportMp4">MP4</button>
                    </div>
                    <div class="row">
                        <button class="btn grow" id="btnReset">Reiniciar Tablero</button>
                    </div>
                </div>
            
                <div id="drawingControlsSection" class="sidepanel-section" style="display:none; flex-direction:column; gap:10px;">
                    <h3 style="font-weight:700; font-size:1.1rem; color:var(--accent);">Herramientas de Dibujo</h3>
                    <div class="row">
                        <div class="seg" id="toolSeg">
                            <button id="toolArrows" class="active">Flechas</button>
                            <button id="toolPen">Lápiz</button>
                            <button id="toolText">Texto</button>
                        </div>
                        <button class="btn" id="btnUndo">Deshacer</button>
                        <button class="btn" id="btnClear">Borrar</button>
                    </div>
                    <div class="row">
                        <div class="field">
                            <label>Color</label>
                            <select id="strokeColor">
                                <option value="#ffffff">Blanco</option>
                                <option value="#35d07f">Verde</option>
                                <option value="#2f80ff">Azul</option>
                                <option value="#ff5a6b">Rojo</option>
                                <option value="#ffd400" selected>Amarillo</option>
                            </select>
                        </div>
                        <div class="field">
                            <label>Grosor</label>
                            <select id="strokeWidth">
                                <option value="3">Fino</option>
                                <option value="5" selected>Medio</option>
                                <option value="7">Grueso</option>
                            </select>
                        </div>
                        <div class="field">
                            <input type="checkbox" id="dashed"> <label for="dashed">Punteado</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="field">
                            <input type="checkbox" id="showGrid"> <label for="showGrid">Ver grilla</label>
                        </div>
                    </div>
                </div>
            
                <div id="playManagementSection" class="sidepanel-section" style="display:none; flex-direction:column; gap:10px;">
                    <h3 style="font-weight:700; font-size:1.1rem; color:var(--accent);">Gestión de Jugadas</h3>
                    <div class="field grow">
                        <label class="subtle">Nombre de Jugada</label>
                        <input type="text" id="playName" placeholder="Ej: Lineout 8" class="grow"/>
                    </div>
                    <div class="row">
                        <button class="btn" id="btnDuplicate">Duplicar</button>
                        <select id="playList" class="btn grow">
                            <option value="">Inicia sesión para ver jugadas</option>
                        </select>
                        <button class="btn" id="btnDelete">Eliminar</button>
                    </div>
                    <div class="row">
                        <button class="btn grow" id="btnSavePlay">Guardar Jugada</button>
                        <button class="btn grow" id="btnLoadPlay">Cargar Jugada</button>
                    </div>
                </div>

                <div id="timelineSection" class="sidepanel-section" style="display:none; flex-direction:column; gap:10px;">
                    <h3 style="font-weight:700; font-size:1.1rem; color:var(--accent);">Control de Animación</h3>
                    <div class="row">
                        <button class="btn grow" id="btnRecord">Grabar paso</button>
                        <div class="field">
                            <input type="checkbox" id="autoRec"> <label for="autoRec">Auto al soltar</label>
                        </div>
                    </div>
                    <div class="row">
                        <button class="btn primary" id="btnPlayPause">Reproducir</button>
                        <button class="btn" id="btnStop">Stop</button>
                        <div class="field grow">
                            <label>Velocidad (ms)</label>
                            <input type="number" id="speed" min="100" step="100" value="800" style="width:100px"/>
                        </div>
                    </div>
                    <div class="field grow">
                        <label>Frame</label>
                        <input type="range" id="scrubber" min="0" max="0" value="0" class="grow"/>
                        <span id="scrubLbl" class="subtle">0/0</span>
                    </div>
                    <button class="btn" id="btnClrTl">Limpiar animación</button>
                </div>
            </aside>

            <section class="board-viewport" id="boardViewport">
                <div class="board-wrap" id="boardWrap">
                    <div class="board" id="board">
                        <svg class="lines" viewBox="0 0 1200 700" preserveAspectRatio="none" aria-hidden="true">
                            <rect x="5" y="5" width="1190" height="690" fill="none" stroke="#fff" stroke-width="6"/>
                            <rect x="0" y="0" width="80" height="700" fill="rgba(255,255,255,.07)"/>
                            <rect x="1120" y="0" width="80" height="700" fill="rgba(255,255,255,.07)"/>
                            <line x1="80" y1="0" x2="80" y2="700" stroke="#fff" stroke-width="4"/>
                            <line x1="1120" y1="0" x2="1120" y2="700" stroke="#fff" stroke-width="4"/>
                            <line x1="309" y1="0" x2="309" y2="700" stroke="#fff" stroke-width="3"/>
                            <line x1="891" y1="0" x2="891" y2="700" stroke="#fff" stroke-width="3"/>
                            <line x1="500" y1="0" x2="500" y2="700" stroke="#fff" stroke-width="2" stroke-dasharray="8 10"/>
                            <line x1="697" y1="0" x2="697" y2="700" stroke="#fff" stroke-width="2" stroke-dasharray="8 10"/>
                            <line x1="600" y1="0" x2="600" y2="700" stroke="#fff" stroke-width="4"/>
                            <line x1="5" y1="50" x2="1195" y2="50" stroke="#fff" stroke-width="2" stroke-dasharray="4 8"/>
                            <line x1="5" y1="150" x2="1195" y2="150" stroke="#fff" stroke-width="2" stroke-dasharray="4 8"/>
                            <line x1="5" y1="550" x2="1195" y2="550" stroke="#fff" stroke-width="2" stroke-dasharray="4 8"/>
                            <line x1="5" y1="650" x2="1195" y2="650" stroke="#fff" stroke-width="2" stroke-dasharray="4 8"/>
                            <line x1="130" y1="0" x2="130" y2="700" stroke="#fff" stroke-width="2" stroke-dasharray="8 10"/>
                            <line x1="1070" y1="0" x2="1070" y2="700" stroke="#fff" stroke-width="2" stroke-dasharray="8 10"/>
                        </svg>

                        <svg class="grid" id="grid" viewBox="0 0 1200 700" preserveAspectRatio="none"></svg>
                        <svg class="draw" id="draw" viewBox="0 0 1200 700" preserveAspectRatio="none"></svg>
                        <div id="players"></div>
                        <div id="ball" class="ball" title="Balón"></div>
                        <div id="selectionBox"></div>
                    </div>
                </div>
                <canvas id="exportCanvas" width="1200" height="700" style="display:none"></canvas>
            </section>
        </main>
    </div>

<script>
// ==================== APLICACIÓN MODULARIZADA ====================
(function() {
    "use strict";

    // --- CONSTANTES ---
    const WIDTH = 1200, HEIGHT = 700, PLAYER_SIZE = 40;
    const initialPositions = [];
    for(let i=1;i<=15;i++) initialPositions.push({team:'team-1', number:i, x:WIDTH*0.18,y:HEIGHT*(0.1+(i-1)*(0.8/14))});
    for(let i=1;i<=15;i++) initialPositions.push({team:'team-2', number:i, x:WIDTH*0.82,y:HEIGHT*(0.1+(i-1)*(0.8/14))});

    // --- ESTADO DE LA APLICACIÓN ---
    const AppState = {
        ffmpeg: null,
        isAuthorized: false,
        currentUser: null,
        userRole: 'spectator',
        currentCoachId: null,
        unsubscribePlays: null,
        timeline: [],
        drawings: { arrows: [], strokes: [], notes: [] },
        currentBallPos: { x: WIDTH / 2, y: HEIGHT / 2 },
        selectedPlayers: new Set(),
        isDragging: false,
        playing: false,
        rafId: null,
        playIdx: 0,
        layout: { mode: 'landscape', scale: 1, tx: 0, ty: 0 },
        forcePortrait: false,
        currentTool: 'arrows'
    };

    // --- MÓDULO DE INTERFAZ DE USUARIO (UI) ---
    const UI = {
        els: {},
        assignDOMElements() {
            const ids = [
                'desktopSidepanel', 'boardViewport', 'boardWrap', 'board', 'players', 'draw', 
                'grid', 'ball', 'selectionBox', 'loginModal', 'btnAuthAction', 
                'menuOverlay', 'btnCloseMenu', 'btnMenuOpen', 'btnLandscape', 'btnPortrait', 
                'btnReset', 'btnSavePlay', 'btnLoadPlay', 'btnExportJpg', 'btnExportWebm', 
                'btnExportMp4', 'toolArrows', 'toolPen', 'toolText', 'strokeColor', 'strokeWidth',
                'dashed', 'showGrid', 'btnUndo', 'btnClear', 'playName', 'btnDuplicate', 
                'playList', 'btnDelete', 'btnRecord', 'autoRec', 'btnPlayPause', 'btnStop', 
                'speed', 'scrubber', 'scrubLbl', 'btnClrTl', 'btnInvitePlayer', 'playerEmail',
                'loginEmail', 'loginPassword', 'btnLogin', 'btnCloseLogin', 'loginMessage', 'menuHeader'
            ];
            ids.forEach(id => this.els[id] = document.getElementById(id));
        },
        showStatus(message, color = 'var(--accent)') {
            const statusDiv = document.createElement('div');
            statusDiv.textContent = message;
            statusDiv.style.cssText = `position: fixed; top: 70px; right: 20px; background: ${color}; color: var(--bg); padding: 10px 15px; border-radius: 8px; z-index: 9999; opacity: 0; transition: opacity 0.5s ease-in-out; max-width: 80%;`;
            document.body.appendChild(statusDiv);
            setTimeout(() => { statusDiv.style.opacity = 1; }, 10);
            setTimeout(() => { statusDiv.style.opacity = 0; setTimeout(() => statusDiv.remove(), 500); }, 3000);
        },
        updateAuthUI() {
            const { isAuthorized, userRole } = AppState;
            const coachControls = ['playManagementSection', 'playerManagementSection', 'timelineSection', 'drawingControlsSection'];
            this.els.btnAuthAction.textContent = isAuthorized ? 'Cerrar Sesión' : 'Iniciar Sesión';
            const displayStyle = (isAuthorized && userRole === 'coach') ? 'flex' : 'none';
            coachControls.forEach(id => {
                const section = document.getElementById(id);
                if(section) section.style.display = displayStyle;
            });
            if (isAuthorized) DB.refreshPlayList();
            else this.els.playList.innerHTML = '<option value="">Inicia sesión para ver jugadas</option>';
        },
        populatePlayList(jugadas) {
            this.els.playList.innerHTML = '';
            const placeholder = Object.assign(document.createElement('option'), {
                value: '', textContent: jugadas.length > 0 ? '--- Seleccionar Jugada ---' : 'No hay jugadas guardadas',
                disabled: true, selected: true
            });
            this.els.playList.appendChild(placeholder);
            jugadas.forEach(j => {
                const opt = document.createElement('option');
                opt.value = j.id;
                opt.textContent = j.name;
                opt.dataset.payload = j.payload;
                this.els.playList.appendChild(opt);
            });
        },
        openMobileMenu() { this.els.desktopSidepanel.classList.add('open'); this.els.menuOverlay.classList.add('open'); },
        closeMobileMenu() { this.els.desktopSidepanel.classList.remove('open'); this.els.menuOverlay.classList.remove('open'); }
    };

    // --- MÓDULO DE AUTENTICACIÓN ---
    const Auth = {
        init() {
            window.firebaseOnAuthStateChanged(window.firebaseAuth, async (user) => {
                if (user) {
                    Object.assign(AppState, { currentUser: user, isAuthorized: true, userRole: 'coach', currentCoachId: user.uid });
                } else {
                    Object.assign(AppState, { currentUser: null, isAuthorized: false, userRole: 'spectator', currentCoachId: null });
                    if (AppState.unsubscribePlays) AppState.unsubscribePlays();
                }
                UI.updateAuthUI();
                Board.reInitializePlayerInteractions();
            });
        },
        async login(email, password) {
            try {
                await window.firebaseSignIn(window.firebaseAuth, email, password);
                UI.showStatus('¡Sesión iniciada!', 'var(--accent2)');
                UI.els.loginModal.style.display = 'none';
                UI.els.loginMessage.textContent = '';
            } catch (error) { UI.els.loginMessage.textContent = error.message; }
        },
        async logout() {
            await window.firebaseSignOut(window.firebaseAuth);
            UI.showStatus('Sesión cerrada', 'var(--accent)');
        }
    };

    // --- MÓDULO DE BASE DE DATOS ---
    const DB = {
        getCoachPlaysCollectionRef() { return window.firestore.collection(window.firebaseDb, `coaches/${AppState.currentCoachId}/plays`); },
        async savePlay(name) {
            if (AppState.userRole !== 'coach' || !name) return UI.showStatus('Ingresa un nombre para la jugada', 'var(--warn)');
            if (AppState.timeline.length === 0) Timeline.recordFrame();
            const playId = name.replace(/[^a-zA-Z0-9_-]/g, '_').toLowerCase();
            const payload = {
                name, timeline: AppState.timeline, drawings: AppState.drawings,
                updatedAt: new Date().toISOString()
            };
            try {
                await window.firestore.setDoc(window.firestore.doc(this.getCoachPlaysCollectionRef(), playId), payload, { merge: true });
                UI.showStatus('Jugada guardada', 'var(--accent2)');
            } catch (e) { UI.showStatus(`Error al guardar: ${e.message}`, 'var(--red)'); }
        },
        refreshPlayList() {
            if (!AppState.currentCoachId) return;
            if (AppState.unsubscribePlays) AppState.unsubscribePlays();
            const q = window.firestore.query(this.getCoachPlaysCollectionRef());
            AppState.unsubscribePlays = window.firestore.onSnapshot(q, (snapshot) => {
                const jugadas = snapshot.docs.map(doc => ({ id: doc.id, name: doc.data().name || doc.id, payload: JSON.stringify(doc.data()) }));
                UI.populatePlayList(jugadas);
            }, (error) => UI.showStatus('Error de conexión con DB.', 'var(--red)'));
        },
        loadPlay(playId) {
            const option = Array.from(UI.els.playList.options).find(opt => opt.value === playId);
            if (!option) return;
            try {
                const data = JSON.parse(option.dataset.payload);
                Timeline.stopAnimation();
                UI.els.playName.value = data.name || playId;
                AppState.drawings = data.drawings || { arrows: [], strokes: [], notes: [] };
                AppState.timeline = Array.isArray(data.timeline) ? data.timeline : [];
                Board.renderDraw();
                Timeline.updateScrub();
                if (AppState.timeline.length) Timeline.gotoFrame(0);
                UI.showStatus(`Jugada '${data.name}' cargada`, 'var(--accent)');
            } catch (e) { UI.showStatus('Error al cargar la jugada.', 'var(--red)'); }
        },
        async deletePlay(playId) {
            if (confirm('¿Seguro que quieres eliminar esta jugada?')) {
                try {
                    await window.firestore.deleteDoc(window.firestore.doc(this.getCoachPlaysCollectionRef(), playId));
                    UI.showStatus('Jugada eliminada', 'var(--accent)');
                    UI.els.playName.value = '';
                } catch (error) { UI.showStatus('Error al eliminar.', 'var(--red)'); }
            }
        }
    };

    // --- MÓDULO DE EXPORTACIÓN ---
    const Export = {
        async exportToImage() {
            UI.showStatus('Generando imagen...', 'var(--warn)');
            try {
                const canvas = await html2canvas(UI.els.boardWrap, { useCORS: true, logging: false, width: WIDTH, height: HEIGHT, scale: 1 });
                const a = document.createElement('a');
                a.href = canvas.toDataURL('image/jpeg', 0.9);
                a.download = 'rugbyboard-frame.jpg';
                a.click();
                UI.showStatus('Imagen exportada', 'var(--accent2)');
            } catch (error) { UI.showStatus('Error al exportar imagen.', 'var(--red)'); }
        },
        async recordVideo(format = 'webm') {
            if (AppState.timeline.length < 2) return UI.showStatus('Se necesitan al menos 2 pasos.', 'var(--red)');
            if (!AppState.ffmpeg) {
                try {
                    AppState.ffmpeg = new window.FFmpeg.FFmpeg();
                    AppState.ffmpeg.on('log', ({ message }) => console.log(message));
                    AppState.ffmpeg.on('progress', ({ progress }) => UI.showStatus(`Exportando: ${(progress * 100).toFixed(0)}%`, 'var(--warn)'));
                    await AppState.ffmpeg.load();
                } catch (e) { return UI.showStatus('Error al cargar FFmpeg.', 'var(--red)'); }
            }
            UI.showStatus(`Iniciando exportación a ${format.toUpperCase()}...`, 'var(--warn)');
            Timeline.stopAnimation();
            const FRAME_RATE = 20, f = AppState.ffmpeg, capturedFrames = [];
            try {
                for (let i = 0; i < AppState.timeline.length - 1; i++) {
                    const from = AppState.timeline[i], to = AppState.timeline[i + 1];
                    for (let j = 0; j < FRAME_RATE; j++) {
                        const frame = Timeline.getInterpolatedFrame(from, to, j / FRAME_RATE);
                        const canvas = await this.renderFrameToCanvas(frame);
                        capturedFrames.push(canvas.toDataURL('image/png'));
                    }
                }
                const lastCanvas = await this.renderFrameToCanvas(AppState.timeline[AppState.timeline.length - 1]);
                capturedFrames.push(lastCanvas.toDataURL('image/png'));
                
                for (let i = 0; i < capturedFrames.length; i++) {
                    const frameName = `frame-${String(i).padStart(4, '0')}.png`;
                    const data = await fetch(capturedFrames[i]).then(r => r.arrayBuffer());
                    await f.writeFile(frameName, new Uint8Array(data));
                }
                
                const outputName = `rugbyboard-play.${format}`;
                const command = ['-framerate', `${FRAME_RATE}`, '-i', 'frame-%04d.png', '-c:v', (format === 'mp4' ? 'libx264' : 'libvpx-vp9'), '-pix_fmt', 'yuv420p', outputName];
                await f.exec(command);
                const data = await f.readFile(outputName);
                const blob = new Blob([data.buffer], { type: `video/${format}` });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = outputName;
                a.click();
                URL.revokeObjectURL(a.href);
                UI.showStatus(`Video ${format.toUpperCase()} exportado.`, 'var(--accent2)');
            } catch (error) { UI.showStatus('Error exportando video.', 'var(--red)'); console.error(error);
            } finally { Timeline.gotoFrame(AppState.playIdx); }
        },
        async renderFrameToCanvas(frameState) {
            Board.applyFrame(frameState);
            await new Promise(r => requestAnimationFrame(r));
            return html2canvas(UI.els.boardWrap, { useCORS: true, logging: false, width: WIDTH, height: HEIGHT, scale: 1 });
        }
    };
    
    // --- MÓDULO DEL TABLERO (BOARD) ---
    const Board = {
        init() {
            this.createPlayers();
            this.placeBall(WIDTH/2, HEIGHT/2);
            Timeline.recordFrame();
            this.fitBoard();
            this.initInteractions();
            this.renderDraw();
        },
        createPlayers() {
            UI.els.players.innerHTML='';
            AppState.selectedPlayers.clear();
            initialPositions.forEach(p => {
                const el = document.createElement('div');
                el.className = `player ${p.team === 'team-1' ? 'team-1' : 'team-2'}`;
                el.textContent = p.number;
                el.dataset.team = p.team;
                el.dataset.number = p.number;
                el.style.left = p.x + 'px';
                el.style.top = p.y + 'px';
                UI.els.players.appendChild(el);
            });
        },
        placeBall(x = WIDTH/2, y = HEIGHT/2) {
            AppState.currentBallPos = { x, y };
            UI.els.ball.style.left = x + 'px';
            UI.els.ball.style.top = y + 'px';
        },
        applyFrame(frame) {
            frame.players.forEach(p => {
                const el = [...UI.els.players.children].find(e => e.dataset.team === p.team && +e.dataset.number === p.number);
                if (el) { el.style.left = p.x + 'px'; el.style.top = p.y + 'px'; }
            });
            this.placeBall(frame.ball.x, frame.ball.y);
        },
        reInitializePlayerInteractions() {
            // Utilizando delegación, esta función compleja ya no es necesaria.
            // Los listeners están en el contenedor.
        },
        fitBoard() {
            const vp = UI.els.boardViewport.getBoundingClientRect();
            const isMobile = window.innerWidth <= 999;
            if (AppState.forcePortrait || isMobile) {
                AppState.layout.mode = 'portrait';
                AppState.layout.scale = Math.min(vp.width / HEIGHT, vp.height / WIDTH);
                UI.els.boardWrap.style.transform = `rotate(90deg) scale(${AppState.layout.scale})`;
            } else {
                AppState.layout.mode = 'landscape';
                AppState.layout.scale = Math.min(vp.width / WIDTH, vp.height / HEIGHT);
                UI.els.boardWrap.style.transform = `scale(${AppState.layout.scale})`;
            }
            this.applyUprightTransforms();
        },
        applyUprightTransforms() {
            const rotate = (AppState.layout.mode === 'portrait');
            [...UI.els.players.children].forEach(el => el.style.transform = `translate(-50%,-50%) rotate(${rotate ? -90 : 0}deg)`);
        },
        clientToBoard(e) {
            const vp = UI.els.boardViewport.getBoundingClientRect();
            const cx = e.clientX - vp.left, cy = e.clientY - vp.top;
            if (AppState.layout.mode === 'portrait') {
                const px = cx - vp.width / 2, py = cy - vp.height / 2;
                const x_board = (WIDTH / 2) + (py / AppState.layout.scale);
                const y_board = (HEIGHT / 2) + (-px / AppState.layout.scale);
                return { x: Math.max(0, Math.min(WIDTH, x_board)), y: Math.max(0, Math.min(HEIGHT, y_board)) };
            }
            const scaledW = WIDTH * AppState.layout.scale, scaledH = HEIGHT * AppState.layout.scale;
            const x = (cx - (vp.width - scaledW) / 2) / AppState.layout.scale;
            const y = (cy - (vp.height - scaledH) / 2) / AppState.layout.scale;
            return { x: Math.max(0, Math.min(WIDTH, x)), y: Math.max(0, Math.min(HEIGHT, y)) };
        },
        deltaToBoard(dx, dy) {
            if (AppState.layout.mode === 'portrait') return { dx: dy / AppState.layout.scale, dy: -dx / AppState.layout.scale };
            return { dx: dx / AppState.layout.scale, dy: dy / AppState.layout.scale };
        },
        renderDraw() {
            UI.els.draw.innerHTML = '';
            const { arrows, strokes, notes } = AppState.drawings;
            arrows.forEach(a => {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                Object.assign(line, {
                    'x1': { baseVal: { value: a.x1 } }, 'y1': { baseVal: { value: a.y1 } },
                    'x2': { baseVal: { value: a.x2 } }, 'y2': { baseVal: { value: a.y2 } },
                });
                line.setAttribute('stroke', a.color); line.setAttribute('stroke-width', a.width);
                if (a.dashed) line.setAttribute('stroke-dasharray', '8 8');
                UI.els.draw.appendChild(line);
            });
            strokes.forEach(s => {
                const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
                polyline.setAttribute('points', s.points.join(' '));
                polyline.setAttribute('fill', 'none'); polyline.setAttribute('stroke', s.color);
                polyline.setAttribute('stroke-width', s.width);
                if (s.dashed) polyline.setAttribute('stroke-dasharray', '8 8');
                UI.els.draw.appendChild(polyline);
            });
        },
        initInteractions() {
            // Usando delegación de eventos
            let activeDrag = null;
            const down = e => {
                if (AppState.userRole !== 'coach') return;
                const playerEl = e.target.closest('.player');
                const ballEl = e.target.closest('#ball');

                if (playerEl) {
                    e.preventDefault();
                    if (!playerEl.classList.contains('selected')) {
                        AppState.selectedPlayers.forEach(p => p.classList.remove('selected'));
                        AppState.selectedPlayers.clear();
                        playerEl.classList.add('selected');
                        AppState.selectedPlayers.add(playerEl);
                    }
                    activeDrag = { type: 'player', initialX: e.clientX, initialY: e.clientY, players: new Map() };
                    AppState.selectedPlayers.forEach(p => activeDrag.players.set(p, { x: parseFloat(p.style.left), y: parseFloat(p.style.top) }));
                    document.addEventListener('pointermove', move);
                    document.addEventListener('pointerup', up);
                } else if (ballEl) {
                     e.preventDefault();
                    activeDrag = { type: 'ball', initialX: e.clientX, initialY: e.clientY, x: AppState.currentBallPos.x, y: AppState.currentBallPos.y };
                    document.addEventListener('pointermove', move);
                    document.addEventListener('pointerup', up);
                } else if (AppState.currentTool !== 'arrows' && AppState.currentTool !== 'pen') {
                    return;
                } else {
                    // Lógica de dibujo
                    e.preventDefault();
                    let p = this.clientToBoard(e);
                    if (AppState.currentTool === 'pen') {
                        activeDrag = { type: 'draw', tool: 'pen', stroke: { points: [`${p.x},${p.y}`], color: UI.els.strokeColor.value, width: UI.els.strokeWidth.value, dashed: UI.els.dashed.checked }};
                        AppState.drawings.strokes.push(activeDrag.stroke);
                    } else if (AppState.currentTool === 'arrows') {
                        activeDrag = { type: 'draw', tool: 'arrow', arrow: { x1: p.x, y1: p.y, x2: p.x, y2: p.y, color: UI.els.strokeColor.value, width: UI.els.strokeWidth.value, dashed: UI.els.dashed.checked }};
                        AppState.drawings.arrows.push(activeDrag.arrow);
                    }
                    this.renderDraw();
                    document.addEventListener('pointermove', move);
                    document.addEventListener('pointerup', up);
                }
            };

            const move = e => {
                if (!activeDrag) return;
                e.preventDefault();
                const { dx, dy } = this.deltaToBoard(e.clientX - activeDrag.initialX, e.clientY - activeDrag.initialY);
                if (activeDrag.type === 'player') {
                    activeDrag.players.forEach((pos, p) => {
                        p.style.left = `${Math.max(0, Math.min(WIDTH, pos.x + dx))}px`;
                        p.style.top = `${Math.max(0, Math.min(HEIGHT, pos.y + dy))}px`;
                    });
                } else if (activeDrag.type === 'ball') {
                    this.placeBall(Math.max(0, Math.min(WIDTH, activeDrag.x + dx)), Math.max(0, Math.min(HEIGHT, activeDrag.y + dy)));
                } else if (activeDrag.type === 'draw') {
                    let p = this.clientToBoard(e);
                    if (activeDrag.tool === 'pen') activeDrag.stroke.points.push(`${p.x},${p.y}`);
                    else if (activeDrag.tool === 'arrow') { activeDrag.arrow.x2 = p.x; activeDrag.arrow.y2 = p.y; }
                    this.renderDraw();
                }
            };
            
            const up = e => {
                if (activeDrag && (activeDrag.type === 'player' || activeDrag.type === 'ball') && UI.els.autoRec.checked) {
                    Timeline.recordFrame();
                }
                activeDrag = null;
                document.removeEventListener('pointermove', move);
                document.removeEventListener('pointerup', up);
            };

            UI.els.board.addEventListener('pointerdown', down);
        }
    };

    // --- MÓDULO DE LÍNEA DE TIEMPO (TIMELINE) ---
    const Timeline = {
        recordFrame() {
            this.stopAnimation();
            if (AppState.playIdx < AppState.timeline.length - 1) AppState.timeline.splice(AppState.playIdx + 1);
            AppState.timeline.push({ players: [...UI.els.players.children].map(el => ({ team: el.dataset.team, number: +el.dataset.number, x: parseFloat(el.style.left), y: parseFloat(el.style.top) })), ball: { ...AppState.currentBallPos } });
            AppState.playIdx = AppState.timeline.length - 1;
            this.updateScrub();
        },
        updateScrub() {
            UI.els.scrubber.max = Math.max(0, AppState.timeline.length - 1);
            UI.els.scrubber.value = AppState.playIdx;
            UI.els.scrubLbl.textContent = `${AppState.playIdx}/${UI.els.scrubber.max}`;
        },
        gotoFrame(i) {
            if (!AppState.timeline.length) return;
            AppState.playIdx = Math.max(0, Math.min(AppState.timeline.length - 1, i));
            this.updateScrub();
            Board.applyFrame(AppState.timeline[AppState.playIdx]);
        },
        startAnimation() {
            if (AppState.timeline.length < 2 || AppState.playing) return;
            AppState.playIdx = parseInt(UI.els.scrubber.value) >= AppState.timeline.length - 1 ? 0 : parseInt(UI.els.scrubber.value);
            this.gotoFrame(AppState.playIdx);
            AppState.playing = true;
            UI.els.btnPlayPause.textContent = 'Pausa';
            let segStart = 0;
            const animate = (timestamp) => {
                if (!AppState.playing) return;
                if (segStart === 0) segStart = timestamp;
                const t = Math.min((timestamp - segStart) / (parseInt(UI.els.speed.value) || 800), 1);
                const current = AppState.timeline[AppState.playIdx], next = AppState.timeline[AppState.playIdx + 1];
                if (current && next) Board.applyFrame(this.getInterpolatedFrame(current, next, t));
                if (t >= 1) {
                    AppState.playIdx++;
                    segStart = timestamp;
                    if (AppState.playIdx >= AppState.timeline.length - 1) { this.stopAnimation(); this.gotoFrame(AppState.playIdx); return; }
                }
                AppState.rafId = requestAnimationFrame(animate);
            };
            AppState.rafId = requestAnimationFrame(animate);
        },
        stopAnimation() {
            if (AppState.rafId) cancelAnimationFrame(AppState.rafId);
            AppState.playing = false;
            AppState.rafId = null;
            UI.els.btnPlayPause.textContent = 'Reproducir';
        },
        getInterpolatedFrame(fromF, toF, t) {
            return {
                players: fromF.players.map(p => {
                    const target = toF.players.find(tp => tp.team === p.team && tp.number === p.number) || p;
                    return { ...p, x: p.x + (target.x - p.x) * t, y: p.y + (target.y - p.y) * t };
                }),
                ball: { x: fromF.ball.x + (toF.ball.x - fromF.ball.x) * t, y: fromF.ball.y + (toF.ball.y - fromF.ball.y) * t }
            };
        }
    };

    // --- INICIALIZACIÓN DE LA APLICACIÓN ---
    document.addEventListener('DOMContentLoaded', () => {
        UI.assignDOMElements();
        Auth.init();
        Board.init();

        // --- BINDING DE EVENTOS ---
        const { els } = UI;
        els.btnAuthAction.addEventListener('click', () => AppState.isAuthorized ? Auth.logout() : els.loginModal.style.display = 'grid');
        els.btnLogin.addEventListener('click', () => Auth.login(els.loginEmail.value, els.loginPassword.value));
        els.btnCloseLogin.addEventListener('click', () => els.loginModal.style.display = 'none');
        
        els.btnSavePlay.addEventListener('click', () => DB.savePlay(els.playName.value));
        els.btnLoadPlay.addEventListener('click', () => els.playList.value && DB.loadPlay(els.playList.value));
        els.btnDelete.addEventListener('click', () => els.playList.value && DB.deletePlay(els.playList.value));
        
        els.btnExportJpg.addEventListener('click', Export.exportToImage);
        els.btnExportWebm.addEventListener('click', () => Export.recordVideo('webm'));
        els.btnExportMp4.addEventListener('click', () => Export.recordVideo('mp4'));
        
        els.btnRecord.addEventListener('click', () => { Timeline.recordFrame(); UI.showStatus('Paso grabado', 'var(--accent2)'); });
        els.scrubber.addEventListener('input', (e) => { Timeline.stopAnimation(); Timeline.gotoFrame(parseInt(e.target.value)); });
        els.btnPlayPause.addEventListener('click', () => AppState.playing ? Timeline.stopAnimation() : Timeline.startAnimation());
        els.btnStop.addEventListener('click', () => { Timeline.stopAnimation(); Timeline.gotoFrame(0); });
        
        els.btnReset.addEventListener('click', () => {
            if (confirm('¿Reiniciar tablero? Se perderán los cambios no guardados.')) {
                Timeline.stopAnimation();
                Board.createPlayers();
                Board.placeBall();
                Object.assign(AppState, { drawings: { arrows: [], strokes: [], notes: [] }, timeline: [] });
                Timeline.recordFrame();
                Board.renderDraw();
                UI.showStatus('Tablero reiniciado', 'var(--accent)');
            }
        });

        els.btnMenuOpen.addEventListener('click', UI.openMobileMenu.bind(UI));
        els.btnCloseMenu.addEventListener('click', UI.closeMobileMenu.bind(UI));
        els.menuOverlay.addEventListener('click', UI.closeMobileMenu.bind(UI));

        els.btnLandscape.addEventListener('click', () => { AppState.forcePortrait=false; Board.fitBoard(); UI.closeMobileMenu(); });
        els.btnPortrait.addEventListener('click', () => { AppState.forcePortrait=true; Board.fitBoard(); UI.closeMobileMenu(); });
        
        ['toolArrows', 'toolPen', 'toolText'].forEach(toolId => {
            els[toolId].addEventListener('click', () => {
                AppState.currentTool = toolId.replace('tool', '').toLowerCase();
                document.querySelectorAll('#toolSeg button').forEach(b => b.classList.remove('active'));
                els[toolId].classList.add('active');
            });
        });

        els.btnClear.addEventListener('click', () => {
            AppState.drawings = { arrows: [], strokes: [], notes: [] };
            Board.renderDraw();
        });

        window.addEventListener('resize', () => Board.fitBoard());
    });
})();
</script>
</body>
</html>
