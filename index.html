<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>RugbyBoard Pro ‚Äî Bologna Rugby Club</title>
<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/umd/ffmpeg.min.js"></script>
<style>
  :root{
    --bg:#0b1520; --panel:#0e1c2a; --panel2:#122235; --ink:#e8eef5; --muted:#9fb3c8;
    --border:#1b3147; --accent:#00c2ff; --accent2:#7ef29a; --warn:#ffd400; --red:#ff5a6b; --blue:#2f80ff;
    --shadow:0 8px 28px rgba(0,0,0,.35);
    --r:12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .app{display:grid;grid-template-rows:auto 1fr;min-height:100dvh}

  /* Top bar */
  .topbar{display:flex;align-items:center;gap:12px;padding:10px 14px;background:linear-gradient(180deg,#0f2235,#0c1a29);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
  .brand{display:flex;align-items:center;gap:10px;font-weight:700}
  .brand .dot{width:12px;height:12px;border-radius:50%;background:var(--accent)}
  .toolbar{display:flex;gap:8px;margin-left:auto;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid var(--border);background:#122538;color:var(--ink);padding:.55rem .8rem;border-radius:10px;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn.primary{background:#0f2a3f;border-color:#22445f}
  .seg{display:flex;border:1px solid var(--border);border-radius:10px;overflow:hidden}
  .seg button{border:none;background:#13293d;padding:.45rem .7rem;color:var(--ink);cursor:pointer}
  .seg button.active{background:#15354f;color:#7fe7ff}

  /* Stage */
  .stage{position:relative;display:grid;grid-template-columns: 1fr;grid-template-rows:1fr;min-height:100%; padding: 0;}
  
  .board-viewport{
    position:relative;
    inset:0;
    display:flex;
    justify-content: center;
    align-items: center;
    overflow:hidden;
    width: 100%;
    height: 100%;
  }
  
  .board-wrap{position:relative; width:1200px; height:700px; transform-origin:center center;} 
  .board{position:absolute;inset:0;background:#137a46;border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
  .lines, .draw{position:absolute;inset:0;pointer-events:none}
  svg{width:100%;height:100%;display:block}
  .grid{position:absolute;inset:0;pointer-events:none;opacity:.55;display:none}
  .grid.on{display:block}

  /* Players & ball */
  #players{position:absolute;inset:0;z-index:3;pointer-events:none}
  .player{pointer-events:auto;position:absolute;width:40px;height:40px;border-radius:50%;display:grid;place-items:center;font-weight:800;font-size:14px;color:#fff;border:2px solid #fff;box-shadow:0 4px 16px rgba(0,0,0,.3);cursor:grab}
  .player.selected{border: 3px solid var(--accent); box-shadow: 0 0 10px var(--accent);}
  .blue{background:var(--blue)} .red{background:var(--red)}
  .team-1{background:var(--blue);}
  .team-2{background:var(--red);}
  
  #ball{position:absolute;z-index:4}
  .ball{width:50px;height:30px;background:var(--warn);border:2px solid #fff;border-radius:50%/60%;transform:translate(-50%,-50%) rotate(-15deg);box-shadow:0 3px 12px rgba(0,0,0,.35);cursor:grab}
  .ball::after{content:"";position:absolute;inset:6px 18px;border-radius:50%/60%;border:2px dashed rgba(0,0,0,.25)}
  
  /* Selection Box */
  #selectionBox{
      position: absolute;
      pointer-events: none;
      border: 1px dashed var(--accent);
      background: rgba(0, 194, 255, 0.1);
      z-index: 5;
      display: none;
  }

  /* Modal Login */
  .modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: rgba(0, 0, 0, 0.7);
    display: none;
    place-items: center;
    z-index: 1000;
  }
  .modal-content {
    background-color: var(--panel);
    padding: 24px;
    border-radius: 12px;
    box-shadow: var(--shadow);
    width: 90%;
    max-width: 400px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    border: 1px solid var(--border);
  }
  .modal-content input {
    width: 100%;
    padding: 10px;
    background: var(--bg);
    color: var(--ink);
    border: 1px solid var(--border);
    border-radius: 8px;
  }
  .modal-content button {
    margin-top: 10px;
  }

  /* Desktop Styles */
  @media (min-width: 1000px){
    .app{grid-template-rows:auto 1fr}
    .stage{
        grid-template-columns: 320px 1fr;
        gap:14px; 
        padding:12px; 
        display: grid; 
        min-height: calc(100dvh - 70px); 
    }
    
    .sidepanel{
        position: relative;
        background:var(--panel);
        border:1px solid var(--border);
        border-radius:12px;
        padding:12px;
        display:flex; 
        flex-direction:column;
        gap:12px; 
        min-height: 100%; 
        overflow-y: auto; 
        transform: translateX(0) !important;
    }
    
    .dock, #btnMenuOpen { display: none !important; }
    
    .sidepanel-section { padding-top: 0 !important; border-top: none !important; }
    .sidepanel-section + .sidepanel-section { border-top: 1px solid var(--border) !important; padding-top: 12px !important; }
  }

  /* Mobile Styles */
  @media (max-width: 999px) {
    .app { 
        min-height: 100dvh; 
        grid-template-rows: auto 1fr; 
    }
    
    .stage {
        padding: 0; 
        min-height: auto;
        height: 100%; 
    }
    .board-viewport {
        width: 100%;
        height: 100%;
    }
    
    .topbar .seg, .topbar .toolbar > .btn { display: none; }
    .topbar #btnAuthAction, .topbar #btnMenuOpen { display: flex; }

    .sidepanel {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: 100%;
        max-width: 100vw;
        z-index: 1000;
        background: var(--bg);
        transform: translateX(-100%);
        transition: transform 0.3s ease-out;
        box-shadow: 4px 0 10px rgba(0,0,0,0.5);
        padding-top: 60px;
        display: flex;
    }
    
    .sidepanel.open {
        transform: translateX(0);
    }
    
    .dock { display: none !important; }
    
    #menuOverlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
    }
    #menuOverlay.open {
        display: block;
    }
  }

  /* Menu header */
  #menuHeader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      z-index: 1001;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      display: none;
      align-items: center;
      justify-content: space-between;
      padding: 0 14px;
  }
  .sidepanel.open ~ #menuHeader {
      display: flex;
  }

  .icon-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    color: var(--ink);
    display: flex;
    align-items: center;
  }
  .icon-btn svg {
    width: 24px;
    height: 24px;
  }
  #btnMenuOpen {
      display: none;
  }
  @media (max-width: 999px) {
      #btnMenuOpen {
          display: inline-block;
      }
  }

  /* Form elements */
  .field{display:flex;align-items:center;gap:8px;background:#0f2032;border:1px solid var(--border);border-radius:10px;padding:.5rem .6rem}
  .field label{font-size:.85rem;color:var(--muted)}
  select,input[type="number"],input[type="text"]{background:#0c1c2b;color:var(--ink);border:1px solid var(--border);border-radius:8px;padding:.45rem .55rem}
  input[type="checkbox"]{width:18px;height:18px}
  .grow{flex:1}
  .subtle{color:var(--muted);font-size:.85rem}
  .row{display:flex;flex-wrap:wrap;gap:8px}

</style>

<!-- Firebase SDK como m√≥dulo -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, deleteDoc, collection, query, onSnapshot, getDocs, where } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyACU3QfuTpW6PNRt3hHl9m1dy4Vso0GPoI",
    authDomain: "bologna-rugby-club.firebaseapp.com",
    projectId: "bologna-rugby-club",
    storageBucket: "bologna-rugby-club.firebasestorage.app",
    messagingSenderId: "641438144435",
    appId: "1:641438144435:web:e2a243bacd522fd1615dc6",
    measurementId: "G-9C66KXJ561"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Exponer Firebase al √°mbito global
  window.firebaseApp = app;
  window.firebaseAuth = auth;
  window.firebaseDb = db;
  window.firebaseSignIn = signInWithEmailAndPassword;
  window.firebaseSignOut = signOut;
  window.firebaseOnAuthStateChanged = onAuthStateChanged;
  
  // Funciones de Firestore
  window.firestore = {
    doc, setDoc, deleteDoc, collection, query, onSnapshot, getDocs, where
  };

  console.log("Firebase inicializado correctamente");
</script>
</head>
<body>
  <!-- Overlay para cerrar men√∫ m√≥vil -->
  <div id="menuOverlay" style="display:none;"></div>

  <!-- Modal de Login -->
  <div class="modal-overlay" id="loginModal">
    <div class="modal-content">
        <h3 style="font-weight:700; color:var(--accent);">Acceso Bologna Rugby Club</h3>
        <p class="subtle">Ingresa tus credenciales para acceder al tablero.</p>
        
        <input type="email" id="loginEmail" placeholder="Email"/>
        <input type="password" id="loginPassword" placeholder="Contrase√±a"/>
        
        <button class="btn primary" id="btnLogin">Iniciar Sesi√≥n</button>
        <p id="loginMessage" style="color:var(--red); font-size:0.85rem; margin:0;"></p>
        <button class="btn" id="btnCloseLogin">Cerrar</button>
    </div>
  </div>
  
  <!-- Contenedor del header m√≥vil -->
  <div id="menuHeader">
      <span class="brand" style="font-size: 1.1rem;"><span class="dot"></span>Controles</span>
      <button class="icon-btn" id="btnCloseMenu">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
      </button>
  </div>

  <!-- Contenedor de la aplicaci√≥n -->
  <div class="app">
    <!-- Topbar -->
    <header class="topbar">
      <div class="brand" id="brand"><span class="dot"></span>Bologna Rugby Club - RugbyBoard</div>

      <div class="toolbar">
        <button class="btn primary" id="btnAuthAction">Iniciar Sesi√≥n</button>
        <button class="icon-btn" id="btnMenuOpen">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
              </svg>
         </button>
      </div>
    </header>

    <!-- Main stage -->
    <main class="stage">
      
      <!-- Panel lateral -->
      <aside class="sidepanel" id="desktopSidepanel">
          
        <!-- Gesti√≥n de Jugadores (solo para entrenadores) -->
        <div id="playerManagementSection" class="sidepanel-section" style="display:flex; flex-direction:column; gap:10px;">
            <h3 style="font-weight:700; font-size:1.1rem; color:var(--accent);">Gestionar Jugadores</h3>
            <div class="field grow">
                <input type="email" id="playerEmail" placeholder="Email del jugador" class="grow"/>
            </div>
            <div class="row">
                <button class="btn grow" id="btnInvitePlayer">Invitar Jugador</button>
            </div>
            <p class="subtle">Los jugadores invitados podr√°n ver tus jugadas</p>
        </div>

        <!-- Controles de Orientaci√≥n -->
        <div id="orientationControls" class="sidepanel-section" style="display:flex; flex-direction:column; gap:10px;">
             <h3 style="font-weight:700; font-size:1.1rem; color:var(--accent);">Orientaci√≥n</h3>
             <div class="seg" style="margin-top: 5px;">
                  <button id="btnLandscape" class="active" title="Horizontal">
                      Horizontal
                  </button>
                  <button id="btnPortrait" title="Vertical">
                      Vertical
                  </button>
             </div>
        </div>

        <!-- Exportaci√≥n y Utilidades -->
        <div id="exportUtilitiesSection" class="sidepanel-section" style="display:flex; flex-direction:column; gap:10px;">
          <h3 style="font-weight:700; font-size:1.1rem; color:var(--accent);">Exportaci√≥n</h3>
          <div class="row">
            <button class="btn grow" id="btnExportJpg">JPG</button>
            <button class="btn grow" id="btnExportWebm">WebM</button>
            <button class="btn grow" id="btnExportMp4">MP4</button>
          </div>
          <div class="row">
             <button class="btn grow" id="btnReset">Reiniciar Tablero</button>
          </div>
        </div>
        
        <!-- Controles de dibujo -->
        <div id="drawingControlsSection" class="sidepanel-section" style="display:flex; flex-direction:column; gap:10px;">
          <h3 style="font-weight:700; font-size:1.1rem; color:var(--accent);">Herramientas de Dibujo</h3>
          <div class="row">
            <div class="seg" id="toolSeg">
              <button id="toolArrows" class="active">Flechas</button>
              <button id="toolPen">L√°piz</button>
              <button id="toolText">Texto</button>
            </div>
            <button class="btn" id="btnUndo">Deshacer</button>
            <button class="btn" id="btnClear">Borrar</button>
          </div>
          <div class="row">
            <div class="field">
              <label>Color</label>
              <select id="strokeColor">
                <option value="#ffffff">Blanco</option>
                <option value="#35d07f">Verde</option>
                <option value="#2f80ff">Azul</option>
                <option value="#ff5a6b">Rojo</option>
                <option value="#ffd400" selected>Amarillo</option>
              </select>
            </div>
            <div class="field">
              <label>Grosor</label>
              <select id="strokeWidth">
                <option value="3">Fino</option>
                <option value="5" selected>Medio</option>
                <option value="7">Grueso</option>
              </select>
            </div>
            <div class="field">
              <input type="checkbox" id="dashed"> <label for="dashed">Punteado</label>
            </div>
          </div>
          <div class="row">
            <div class="field">
              <input type="checkbox" id="showGrid"> <label for="showGrid">Ver grilla</label>
            </div>
          </div>
        </div>
        
        <!-- Gesti√≥n de Jugadas -->
        <div id="playManagementSection" class="sidepanel-section" style="display:flex; flex-direction:column; gap:10px;">
          <h3 style="font-weight:700; font-size:1.1rem; color:var(--accent);">Gesti√≥n de Jugadas</h3>
          <div class="field grow">
            <label class="subtle">Nombre de Jugada</label>
            <input type="text" id="playName" placeholder="Ej: Lineout 8" class="grow"/>
          </div>
          <div class="row">
            <button class="btn" id="btnDuplicate">Duplicar</button>
            <select id="playList" class="btn grow">
              <option value="">Inicia sesi√≥n para ver jugadas</option>
            </select>
            <button class="btn" id="btnDelete">Eliminar</button>
          </div>
          <div class="row">
            <button class="btn grow" id="btnSavePlay">Guardar Jugada</button>
            <button class="btn grow" id="btnLoadPlay">Cargar Jugada</button>
          </div>
        </div>

        <!-- Timeline y Animaci√≥n -->
        <div id="timelineSection" class="sidepanel-section" style="display:flex; flex-direction:column; gap:10px;">
          <h3 style="font-weight:700; font-size:1.1rem; color:var(--accent);">Control de Animaci√≥n</h3>
          <div class="row">
            <button class="btn grow" id="btnRecord">Grabar paso</button>
            <div class="field">
              <input type="checkbox" id="autoRec"> <label for="autoRec">Auto al soltar</label>
            </div>
          </div>
          <div class="row">
            <button class="btn primary" id="btnPlayPause">Reproducir</button>
            <button class="btn" id="btnStop">Stop</button>
            <div class="field grow">
              <label>Velocidad (ms)</label>
              <input type="number" id="speed" min="100" step="100" value="800" style="width:100px"/>
            </div>
          </div>
          <div class="field grow">
            <label>Frame</label>
            <input type="range" id="scrubber" min="0" max="0" value="0" class="grow"/>
            <span id="scrubLbl" class="subtle">0/0</span>
          </div>
          <button class="btn" id="btnClrTl">Limpiar animaci√≥n</button>
        </div>
      </aside>

      <section class="board-viewport" id="boardViewport">
        <div class="board-wrap" id="boardWrap">
          <div class="board" id="board">
            <!-- field lines -->
            <svg class="lines" viewBox="0 0 1200 700" preserveAspectRatio="none" aria-hidden="true">
              <rect x="5" y="5" width="1190" height="690" fill="none" stroke="#fff" stroke-width="6"/>
              <rect x="0" y="0" width="80" height="700" fill="rgba(255,255,255,.07)"/>
              <rect x="1120" y="0" width="80" height="700" fill="rgba(255,255,255,.07)"/>
              <line x1="80" y1="0" x2="80" y2="700" stroke="#fff" stroke-width="4"/>
              <line x1="1120" y1="0" x2="1120" y2="700" stroke="#fff" stroke-width="4"/>
              <line x1="309" y1="0" x2="309" y2="700" stroke="#fff" stroke-width="3"/>
              <line x1="891" y1="0" x2="891" y2="700" stroke="#fff" stroke-width="3"/>
              <line x1="500" y1="0" x2="500" y2="700" stroke="#fff" stroke-width="2" stroke-dasharray="8 10"/>
              <line x1="697" y1="0" x2="697" y2="700" stroke="#fff" stroke-width="2" stroke-dasharray="8 10"/>
              <line x1="600" y1="0" x2="600" y2="700" stroke="#fff" stroke-width="4"/>
              <line x1="5" y1="50" x2="1195" y2="50" stroke="#fff" stroke-width="2" stroke-dasharray="4 8"/>
              <line x1="5" y1="150" x2="1195" y2="150" stroke="#fff" stroke-width="2" stroke-dasharray="4 8"/>
              <line x1="5" y1="550" x2="1195" y2="550" stroke="#fff" stroke-width="2" stroke-dasharray="4 8"/>
              <line x1="5" y1="650" x2="1195" y2="650" stroke="#fff" stroke-width="2" stroke-dasharray="4 8"/>
              <line x1="130" y1="0" x2="130" y2="700" stroke="#fff" stroke-width="2" stroke-dasharray="8 10"/>
              <line x1="1070" y1="0" x2="1070" y2="700" stroke="#fff" stroke-width="2" stroke-dasharray="8 10"/>
            </svg>

            <svg class="grid" id="grid" viewBox="0 0 1200 700" preserveAspectRatio="none"></svg>
            <svg class="draw" id="draw" viewBox="0 0 1200 700" preserveAspectRatio="none"></svg>
            <div id="players"></div>
            <div id="ball" class="ball" title="Bal√≥n"></div>
            <div id="selectionBox" style="display:none;"></div>
          </div>
        </div>
        <canvas id="exportCanvas" width="1200" height="700" style="display:none"></canvas>
      </section>
    </main>
  </div>

<script>
// Constantes
const WIDTH = 1200, HEIGHT = 700, GRID = 24;

// Variables DOM
let desktopSidepanel, boardViewport, boardWrap, board, playersLayer, draw, gridSvg, ball, exportCanvas, ctx, selectionBox, loginModal, btnAuthAction, menuOverlay, btnCloseMenu, btnMenuOpen;
let btnLandscape, btnPortrait, btnReset, btnSavePlay, btnLoadPlay, btnExportJpg, btnExportWebm, btnExportMp4;
let toolArrows, toolPen, toolText, strokeColor, strokeWidth, dashed, showGrid, btnUndo, btnClear;
let playName, btnDuplicate, playList, btnDelete, btnRecord, autoRec, btnPlayPause, btnStop, speed, scrubber, scrubLbl;
let btnInvitePlayer, playerEmail;

// Funci√≥n que asigna todas las variables DOM
function assignDOMElements() {
    desktopSidepanel = document.getElementById('desktopSidepanel');
    boardViewport = document.getElementById('boardViewport');
    boardWrap = document.getElementById('boardWrap');
    board = document.getElementById('board');
    playersLayer = document.getElementById('players');
    draw = document.getElementById('draw');
    gridSvg = document.getElementById('grid');
    ball = document.getElementById('ball');
    exportCanvas = document.getElementById('exportCanvas');
    ctx = exportCanvas ? exportCanvas.getContext('2d') : null;
    selectionBox = document.getElementById('selectionBox');
    loginModal = document.getElementById('loginModal');
    btnAuthAction = document.getElementById('btnAuthAction');
    menuOverlay = document.getElementById('menuOverlay');
    btnCloseMenu = document.getElementById('btnCloseMenu');
    btnMenuOpen = document.getElementById('btnMenuOpen');

    // Topbar / acciones
    btnLandscape = document.getElementById('btnLandscape');
    btnPortrait = document.getElementById('btnPortrait');
    btnReset = document.getElementById('btnReset');
    btnSavePlay = document.getElementById('btnSavePlay');
    btnLoadPlay = document.getElementById('btnLoadPlay');
    btnExportJpg = document.getElementById('btnExportJpg');
    btnExportWebm = document.getElementById('btnExportWebm');
    btnExportMp4 = document.getElementById('btnExportMp4');

    // Herramientas
    toolArrows = document.getElementById('toolArrows');
    toolPen = document.getElementById('toolPen');
    toolText = document.getElementById('toolText');
    strokeColor = document.getElementById('strokeColor');
    strokeWidth = document.getElementById('strokeWidth');
    dashed = document.getElementById('dashed');
    showGrid = document.getElementById('showGrid');
    btnUndo = document.getElementById('btnUndo');
    btnClear = document.getElementById('btnClear');

    // Jugadas
    playName = document.getElementById('playName');
    btnDuplicate = document.getElementById('btnDuplicate');
    playList = document.getElementById('playList');
    btnDelete = document.getElementById('btnDelete');

    // Timeline
    btnRecord = document.getElementById('btnRecord');
    autoRec = document.getElementById('autoRec');
    btnPlayPause = document.getElementById('btnPlayPause');
    btnStop = document.getElementById('btnStop');
    speed = document.getElementById('speed');
    scrubber = document.getElementById('scrubber');
    scrubLbl = document.getElementById('scrubLbl');

    // Gesti√≥n de jugadores
    btnInvitePlayer = document.getElementById('btnInvitePlayer');
    playerEmail = document.getElementById('playerEmail');
}

// Variables de estado del tablero
let arrows = [], strokes = [], notes = [], timeline = [];
let teamConfig = { 
    team1: { name: 'Bologna RFC', colorClass: 'team-1', hexColor: '#2f80ff' },
    team2: { name: 'Rival', colorClass: 'team-2', hexColor: '#ff5a6b' }
};
const initialPositions = [];
for(let i=1;i<=15;i++) initialPositions.push({team:'team-1', number:i, x:WIDTH*0.18,y:HEIGHT*(0.1+(i-1)*(0.8/14))});
for(let i=1;i<=15;i++) initialPositions.push({team:'team-2', number:i, x:WIDTH*0.82,y:HEIGHT*(0.1+(i-1)*(0.8/14))});
let currentBallPos = {x:WIDTH/2,y:HEIGHT/2};
let selectedPlayers = new Set();

// Variables de animaci√≥n
let playing = false, paused = false, playIdx = 0, rafId = null, segStart = 0, segDur = 800;
let fromF = null, toF = null;

// Layout
let layout = {mode: 'landscape', scale: 1, tx: 0, ty: 0};
let forcePortrait = false;

// Estado de autenticaci√≥n
let isAuthorized = false;
let currentUser = null;
let userRole = 'spectator';
let currentCoachId = null;
let unsubscribePlays = null;

// Utilidades
function showStatus(message, color='var(--accent)'){
    const statusDiv = document.createElement('div');
    statusDiv.className = 'status-message';
    statusDiv.textContent = message;
    statusDiv.style.cssText = `
        position: fixed; top: 70px; right: 20px;
        background: ${color}; color: var(--bg); padding: 10px 15px;
        border-radius: 8px; z-index: 9999; opacity: 0;
        transition: opacity 0.5s ease-in-out;
    `;
    document.body.appendChild(statusDiv);
    
    setTimeout(() => { statusDiv.style.opacity = 1; }, 10);
    setTimeout(() => { statusDiv.style.opacity = 0; }, 3000);
    setTimeout(() => { statusDiv.remove(); }, 3500);
}

function clamp(v, min, max){ return Math.max(min,Math.min(max,v)); }
function dist(ax,ay,bx,by){ const dx=ax-bx, dy=ay-by; return Math.hypot(dx,dy); }
function centerOf(el){ return { x:parseFloat(el.style.left)||0, y:parseFloat(el.style.top)||0 } }

// ==================== SISTEMA DE AUTENTICACI√ìN ====================

function openLoginModal() {
    if(loginModal) loginModal.style.display = 'grid';
}

function closeLoginModal() {
    if(loginModal) loginModal.style.display = 'none';
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPassword').value = '';
    document.getElementById('loginMessage').textContent = '';
}

async function handleLogin() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const loginMessage = document.getElementById('loginMessage');
    
    if (!email || !password) {
        loginMessage.textContent = 'Por favor ingresa email y contrase√±a';
        return;
    }
    
    try {
        loginMessage.textContent = 'Iniciando sesi√≥n...';
        const userCredential = await window.firebaseSignIn(window.firebaseAuth, email, password);
        currentUser = userCredential.user;
        isAuthorized = true;
        
        showStatus('¬°Sesi√≥n iniciada correctamente!', 'var(--accent2)');
        closeLoginModal();
        
    } catch (error) {
        console.error('Error de login:', error);
        let errorMessage = 'Error al iniciar sesi√≥n';
        
        switch(error.code) {
            case 'auth/invalid-email':
                errorMessage = 'Email inv√°lido';
                break;
            case 'auth/user-disabled':
                errorMessage = 'Usuario deshabilitado';
                break;
            case 'auth/user-not-found':
                errorMessage = 'Usuario no encontrado';
                break;
            case 'auth/wrong-password':
                errorMessage = 'Contrase√±a incorrecta';
                break;
            default:
                errorMessage = error.message;
        }
        
        loginMessage.textContent = errorMessage;
    }
}

async function handleLogout() {
    try {
        await window.firebaseSignOut(window.firebaseAuth);
        currentUser = null;
        isAuthorized = false;
        userRole = 'spectator';
        currentCoachId = null;
        
        if (unsubscribePlays) {
            unsubscribePlays();
            unsubscribePlays = null;
        }
        
        showStatus('Sesi√≥n cerrada', 'var(--accent)');
        updateAuthUI();
    } catch (error) {
        console.error('Error al cerrar sesi√≥n:', error);
        showStatus('Error al cerrar sesi√≥n', 'var(--red)');
    }
}

// ==================== SISTEMA MULTI-TENANCY ====================

// VERSI√ìN MEJORADA - checkPlayerAccess
async function checkPlayerAccess() {
    if (!currentUser) {
        console.log('No hay usuario autenticado');
        return null;
    }
    
    console.log('üîê Usuario autenticado:', currentUser.uid, currentUser.email);
    console.log('üìù ID del usuario:', currentUser.uid);
    
    // TEMPORAL: Todos los usuarios son coaches
    userRole = 'coach';
    currentCoachId = currentUser.uid;
    
    console.log('üéØ Asignado como coach con ID:', currentCoachId);
    
    try {
        // Crear autom√°ticamente el documento del coach en Firestore
        const coachDocRef = window.firestore.doc(
            window.firestore.collection(window.firebaseDb, 'coaches'), 
            currentUser.uid
        );
        
        console.log('üìÅ Intentando crear documento en: coaches/' + currentUser.uid);
        
        await window.firestore.setDoc(coachDocRef, {
            email: currentUser.email,
            createdAt: new Date().toISOString(),
            role: 'coach',
            name: currentUser.displayName || currentUser.email.split('@')[0],
            lastLogin: new Date().toISOString()
        });
        
        console.log('‚úÖ Documento de coach creado exitosamente');
        showStatus('¬°Bienvenido Coach! Espacio personal creado', 'var(--accent2)');
        
    } catch (error) {
        console.log('‚ö†Ô∏è  Info del documento (puede que ya exista):', error.message);
        // No es cr√≠tico si falla
    }
    
    return [];
}

// CORRECCI√ìN: Funci√≥n ensureCoachDocument
async function ensureCoachDocument() {
    if (userRole !== 'coach' || !currentUser) return;
    
    try {
        const coachDocRef = window.firestore.doc(
            window.firestore.collection(window.firebaseDb, 'coaches'), 
            currentUser.uid
        );
        
        console.log('‚úÖ Documento de coach verificado:', currentUser.uid);
        
    } catch (error) {
        console.log('‚ÑπÔ∏è  Info del documento coach:', error.message);
    }
}

// Funci√≥n determineUserRole actualizada
async function determineUserRole() {
    if (!currentUser) {
        userRole = 'spectator';
        return;
    }

    console.log('Determinando rol para:', currentUser.email);
    await checkPlayerAccess();
    console.log('Rol determinado:', userRole, 'Coach ID:', currentCoachId);
}

// Obtener referencia a la colecci√≥n de jugadas del entrenador
function getCoachPlaysCollectionRef(coachId = null) {
    const coachUID = coachId || currentCoachId || currentUser.uid;
    return window.firestore.collection(window.firebaseDb, `coaches/${coachUID}/plays`);
}

// Obtener referencia a la colecci√≥n de jugadores del entrenador
function getCoachPlayersCollectionRef(coachId = null) {
    const coachUID = coachId || currentCoachId || currentUser.uid;
    return window.firestore.collection(window.firebaseDb, `coaches/${coachUID}/players`);
}

// Invitar jugador
async function invitePlayer(playerEmail) {
    if (!isAuthorized || userRole !== 'coach') {
        showStatus('ERROR: Solo los entrenadores pueden invitar jugadores.', 'var(--red)');
        return;
    }

    if (!playerEmail) {
        showStatus('Ingresa un email v√°lido', 'var(--red)');
        return;
    }

    try {
        // Crear documento de invitaci√≥n
        const playerDocRef = window.firestore.doc(
            getCoachPlayersCollectionRef(), 
            playerEmail.replace(/[^a-zA-Z0-9]/g, '_')
        );
        
        await window.firestore.setDoc(playerDocRef, {
            email: playerEmail,
            invitedBy: currentUser.uid,
            invitedAt: new Date().toISOString(),
            status: 'pending'
        });
        
        showStatus(`Invitaci√≥n enviada a ${playerEmail}`, 'var(--accent2)');
        
    } catch (error) {
        console.error('Error al invitar jugador:', error);
        showStatus('Error al enviar invitaci√≥n', 'var(--red)');
    }
}

// ==================== GESTI√ìN DE JUGADAS ====================

function snapshotPlayers(){ 
    if (!playersLayer) return [];
    return [...playersLayer.children].map(el=>({
        team:el.dataset.team, 
        number:+el.dataset.number, 
        x:parseFloat(el.style.left), 
        y:parseFloat(el.style.top)
    })); 
}

function snapshotBall(){ return {...currentBallPos}; }
function snapshotFrame(){ 
    return { 
        players: snapshotPlayers(), 
        ball: snapshotBall() 
    }; 
}

// Guardar jugada en el espacio del entrenador
async function savePlay(name) {
    if (!isAuthorized || !currentUser || userRole !== 'coach') {
        showStatus('ERROR: Debes ser entrenador para guardar jugadas.', 'var(--red)');
        return;
    }

    const playId = name.replace(/[^a-zA-Z0-9_-]/g, '_').toLowerCase(); 
    const payload = { 
        name: name,
        positions: snapshotPlayers(), 
        ball: snapshotBall(),
        arrows: arrows, 
        strokes: strokes, 
        notes: notes,
        timeline: timeline,
        teamConfig: teamConfig,
        createdBy: currentUser.uid,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        isPublic: false
    };

    try {
        await window.firestore.setDoc(
            window.firestore.doc(getCoachPlaysCollectionRef(), playId), 
            payload
        );
        showStatus('Jugada guardada en tu espacio personal!', 'var(--accent2)');
        refreshPlayList();
    } catch (e) {
        console.error("Error al guardar jugada:", e);
        showStatus('Error al guardar: ' + e.message, 'var(--red)');
    }
}

// Cargar jugadas del entrenador actual
function refreshPlayList() {
    console.log('üîÑ refreshPlayList iniciado');
    console.log('üë§ Usuario:', currentUser?.email);
    console.log('üÜî Coach ID:', currentCoachId);
    
    if (!currentUser || !currentCoachId) {
        console.log('‚ùå No hay usuario o coach ID');
        if (playList) {
            playList.innerHTML = '<option value="">Inicia sesi√≥n para ver jugadas</option>';
        }
        return;
    }

    // Cancelar suscripci√≥n anterior
    if (unsubscribePlays) {
        console.log('üî¥ Cancelando suscripci√≥n anterior');
        unsubscribePlays();
    }

    try {
        console.log('üéØ Obteniendo colecci√≥n para coach:', currentCoachId);
        const playsCollection = getCoachPlaysCollectionRef();
        
        const q = window.firestore.query(playsCollection);
        console.log('üì° Iniciando suscripci√≥n a jugadas...');
        
        unsubscribePlays = window.firestore.onSnapshot(q, 
            (snapshot) => {
                console.log('üì® Snapshost recibido - Documentos:', snapshot.size);
                const jugadas = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    jugadas.push({ 
                        id: doc.id, 
                        name: data.name || doc.id, 
                        payload: JSON.stringify(data)
                    });
                    console.log('üìù Jugada encontrada:', doc.id);
                });
                
                jugadas.sort((a, b) => a.name.localeCompare(b.name));
                populatePlayList(jugadas);
                
                if (jugadas.length === 0) {
                    console.log('‚ÑπÔ∏è  No hay jugadas guardadas a√∫n');
                    showStatus('Crea tu primera jugada!', 'var(--accent)');
                } else {
                    console.log('‚úÖ ' + jugadas.length + ' jugadas cargadas');
                    showStatus(jugadas.length + ' jugadas cargadas', 'var(--accent2)');
                }
            }, 
            (error) => {
                console.error('üí• ERROR en suscripci√≥n:', error);
                console.error('C√≥digo del error:', error.code);
                console.error('Mensaje:', error.message);
                
                showStatus('Error de conexi√≥n: ' + error.code, 'var(--red)');
                
                if (playList) {
                    playList.innerHTML = '<option value="">Error cargando jugadas</option>';
                }
            }
        );
        
        console.log('‚úÖ Suscripci√≥n iniciada correctamente');
        
    } catch (error) {
        console.error('üí• ERROR en refreshPlayList:', error);
        showStatus('Error: ' + error.message, 'var(--red)');
    }
}

function populatePlayList(jugadas) {
    if (!playList) return;
    
    playList.innerHTML = '';
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = jugadas.length > 0 ? '--- Seleccionar Jugada ---' : 'No hay jugadas guardadas';
    placeholder.disabled = true;
    placeholder.selected = true;
    playList.appendChild(placeholder);
    
    jugadas.forEach(j => {
        const opt = document.createElement('option');
        opt.value = j.id;
        opt.textContent = j.name;
        opt.dataset.payload = j.payload;
        playList.appendChild(opt);
    });
}

// Cargar una jugada espec√≠fica
function loadPlay(playId) {
    if (!playList) return;
    
    const option = Array.from(playList.options).find(opt => opt.value === playId);
    if (!option || !option.dataset.payload) {
        showStatus('Jugada no encontrada', 'var(--red)');
        return;
    }

    try {
        const data = JSON.parse(option.dataset.payload);
        
        // Cargar datos de la jugada
        if (playName) playName.value = data.name || playId;
        
        // Limpiar y recrear jugadores
        if (playersLayer) playersLayer.innerHTML = '';
        selectedPlayers.clear();
        
        (data.positions || []).forEach(p => {
            const el = document.createElement('div');
            el.className = `player ${p.team}`; 
            el.textContent = p.number;
            el.dataset.team = p.team; 
            el.dataset.number = p.number;
            el.style.left = p.x + 'px'; 
            el.style.top = p.y + 'px';
            
            // Solo habilitar drag si es coach
            if (userRole === 'coach') {
                enableDragPlayer(el, () => { 
                    if (autoRec && autoRec.checked) recordFrame(); 
                });
            }
            
            if (playersLayer) playersLayer.appendChild(el);
        });
        
        applyUprightTransforms();

        // Cargar bal√≥n
        placeBall(data.ball?.x || WIDTH/2, data.ball?.y || HEIGHT/2);
        
        // Cargar elementos de dibujo
        arrows = data.arrows || [];
        strokes = data.strokes || [];
        notes = data.notes || [];
        timeline = Array.isArray(data.timeline) ? data.timeline : [];
        
        renderDraw(); 
        updateScrub(); 
        
        if (timeline.length) gotoFrame(0);

        showStatus(`Jugada '${data.name}' cargada`, 'var(--accent)');

    } catch (e) {
        console.error("Error al cargar jugada:", e);
        showStatus('Error al cargar la jugada.', 'var(--red)');
    }
}

// ==================== INTERFAZ DE USUARIO ====================

function setControlsDisabled(disabled) {
    const controls = [
        btnSavePlay, btnDelete, btnRecord, btnDuplicate, autoRec,
        toolArrows, toolPen, toolText, strokeColor, strokeWidth, dashed, 
        showGrid, btnUndo, btnClear, btnReset, btnInvitePlayer, playerEmail
    ];
    
    controls.forEach(btn => { 
        if(btn) btn.disabled = disabled; 
    });
    
    // Siempre habilitar controles de lectura
    const readOnlyControls = [btnLoadPlay, playList, btnPlayPause, btnStop, scrubber];
    readOnlyControls.forEach(el => { 
        if(el) el.disabled = false; 
    });
    
    // El campo de nombre solo para coaches
    if (playName) playName.disabled = disabled;
    
    // Habilitar interacciones del tablero si est√° autorizado y es coach
    const canInteract = !disabled && userRole === 'coach';
    if (board) board.style.pointerEvents = canInteract ? 'auto' : 'none';
    if (playersLayer) playersLayer.style.pointerEvents = canInteract ? 'auto' : 'none';
    if (ball) ball.style.pointerEvents = canInteract ? 'auto' : 'none';

    // Mostrar/ocultar secci√≥n de gesti√≥n de jugadores
    const playerManagementSection = document.getElementById('playerManagementSection');
    if (playerManagementSection) {
        playerManagementSection.style.display = (userRole === 'coach') ? 'flex' : 'none';
    }
}

function updateAuthUI() {
    if (!btnAuthAction) return;
    
    if (isAuthorized && currentUser) {
        btnAuthAction.textContent = 'Cerrar Sesi√≥n';
        btnAuthAction.classList.remove('primary');
        
        let roleText = '';
        if (userRole === 'coach') {
            roleText = ' - Entrenador';
            setControlsDisabled(false);
        } else if (userRole === 'player') {
            roleText = ' - Jugador';
            setControlsDisabled(true);
        }
        
        document.getElementById('brand').innerHTML = `<span class="dot"></span>Bologna Rugby Club${roleText}`;
        
    } else {
        btnAuthAction.textContent = 'Iniciar Sesi√≥n';
        btnAuthAction.classList.add('primary');
        document.getElementById('brand').innerHTML = `<span class="dot"></span>Bologna Rugby Club - Espectador`;
        setControlsDisabled(true);
    }
}

// ==================== FUNCIONES DEL TABLERO ====================

function initBoardApp(){
    console.log("Inicializando aplicaci√≥n...");
    
    // Crear jugadores y bal√≥n
    createPlayers();
    placeBall();
    
    // Timeline inicial
    if (!timeline.length) { recordFrame(); }
    updateScrub();

    // CORRECCI√ìN: Configurar Firebase Auth State Listener
    if (window.firebaseOnAuthStateChanged) {
        // Primero verificar el estado actual inmediatamente
        const currentAuthUser = window.firebaseAuth.currentUser;
        if (currentAuthUser) {
            console.log('‚úÖ Usuario ya autenticado al cargar:', currentAuthUser.email);
            currentUser = currentAuthUser;
            isAuthorized = true;
            (async () => {
                await determineUserRole();
                refreshPlayList();
                updateAuthUI();
            })();
        }

        // Luego configurar el listener para cambios futuros
        window.firebaseOnAuthStateChanged(window.firebaseAuth, async (user) => {
            console.log('üîÑ Auth state changed:', user ? user.email : 'No user');
            
            if (user) {
                currentUser = user;
                isAuthorized = true;
                console.log('‚úÖ Usuario autenticado via listener:', user.email);
                
                await determineUserRole();
                refreshPlayList();
            } else {
                currentUser = null;
                isAuthorized = false;
                userRole = 'spectator';
                currentCoachId = null;
                console.log('üö™ Usuario cerr√≥ sesi√≥n');
                
                if (unsubscribePlays) {
                    unsubscribePlays();
                    unsubscribePlays = null;
                }
            }
            updateAuthUI();
        });
    } else {
        console.log('‚ö†Ô∏è Firebase Auth no disponible - Modo local');
    }

    // INICIALMENTE DESHABILITAR CONTROLES
    setControlsDisabled(true);

    // UI inicial
    if (showGrid) showGrid.checked = false;
    renderGrid();
    renderDraw();
    fitBoard();
    
    // Forzar rec√°lculo del layout
    setTimeout(fitBoard, 50);
    
    showStatus('Sistema Bologna Rugby Club cargado', 'var(--accent2)');
}

// Funciones b√°sicas del tablero (simplificadas)
function createPlayers() {
    if (!playersLayer) return;
    playersLayer.innerHTML='';
    selectedPlayers.clear();
    initialPositions.forEach(p=>{
        const el=document.createElement('div');
        const teamData = p.team === 'team-1' ? teamConfig.team1 : teamConfig.team2;
        el.className=`player ${teamData.colorClass}`; 
        el.textContent = p.number;
        el.dataset.team = p.team; 
        el.dataset.number = p.number;
        el.style.left = p.x+'px'; el.style.top = p.y+'px';
        playersLayer.appendChild(el);
    });
    applyUprightTransforms();
}

function placeBall(x=WIDTH/2,y=HEIGHT/2){
    if (!ball) return;
    currentBallPos.x=x; currentBallPos.y=y;
    ball.style.left=x+'px'; ball.style.top=y+'px';
    ball.style.transform='translate(-50%,-50%) rotate(-15deg)';
}

function fitBoard(){
    if (!boardViewport || !boardWrap) return;
    
    const vp=boardViewport.getBoundingClientRect();
    const availW=vp.width, availH=vp.height;

    const baseW = WIDTH;
    const baseH = HEIGHT;

    let currentW, currentH;
    let scale;

    const isMobile = window.innerWidth <= 999;
    
    if (isMobile) {
        forcePortrait = true; 
    }
    
    if (forcePortrait || isMobile){
        layout.mode='portrait';
        currentW = baseH;
        currentH = baseW;
        scale = Math.min(availW/currentW, availH/currentH);
        layout.scale=scale;
        boardWrap.style.transform=`rotate(90deg) scale(${scale})`;
        boardWrap.style.transformOrigin='center center';
        
        const scaledRotatedW = baseH * scale;
        const scaledRotatedH = baseW * scale;
        layout.tx = (availW - scaledRotatedW) / 2;
        layout.ty = (availH - scaledRotatedH) / 2;

        if (btnPortrait) setSegActive(btnPortrait, btnLandscape);
        
    } else {
        layout.mode='landscape';
        currentW = baseW;
        currentH = baseH;
        scale = Math.min(availW/currentW, availH/currentH);
        layout.scale=scale;
        layout.tx = (availW - currentW * scale) / 2;
        layout.ty = (availH - currentH * scale) / 2;
        boardWrap.style.transform=`scale(${scale})`;
        boardWrap.style.transformOrigin='center center';
        if (btnLandscape) setSegActive(btnLandscape, btnPortrait);
    }

    applyUprightTransforms();
}

function applyUprightTransforms(){
    const rotatePlayers=(layout.mode==='portrait');
    if (!playersLayer) return;
    [...playersLayer.children].forEach(el=>{
        el.style.transform = rotatePlayers
            ? 'translate(-50%,-50%) rotate(-90deg)' 
            : 'translate(-50%,-50%)';
    });
}

function setSegActive(segBtn, otherBtn){
    if(segBtn) segBtn.classList.add('active');
    if(otherBtn) otherBtn.classList.remove('active');
}

function recordFrame(){ 
    timeline.push(snapshotFrame()); 
    updateScrub(); 
}

function updateScrub(){
    if (!scrubber || !scrubLbl) return;
    scrubber.max = Math.max(0, timeline.length - 1);
    scrubLbl.textContent = `0/${timeline.length - 1}`;
}

function renderGrid(){
    if (!gridSvg) return;
    gridSvg.innerHTML='';
    if (!showGrid.checked) { gridSvg.classList.remove('on'); return; }
    gridSvg.classList.add('on');
}

function renderDraw(){
    if (!draw) return;
    draw.innerHTML = '';
}

// Funciones m√≥viles
function openMobileMenu() {
    if(desktopSidepanel) desktopSidepanel.classList.add('open');
    if(menuOverlay) menuOverlay.classList.add('open');
}

function closeMobileMenu() {
    if(desktopSidepanel) desktopSidepanel.classList.remove('open');
    if(menuOverlay) menuOverlay.classList.remove('open');
}

// Funciones de interacci√≥n (simplificadas)
function enableDragPlayer(playerEl, onDrop) {
    // Implementaci√≥n b√°sica - se puede expandir
}

function enableDragBall(onDrop) {
    // Implementaci√≥n b√°sica - se puede expandir
}

function enableSelectionBox() {
    // Implementaci√≥n b√°sica - se puede expandir
}

function initDrawingTools() {
    // Implementaci√≥n b√°sica - se puede expandir
}

function gotoFrame(i){
    // Implementaci√≥n b√°sica
}

// ==================== FUNCIONES DE INTERACCI√ìN COMPLETAS ====================

function enableDragPlayer(playerEl, onDrop) {
    if (!isAuthorized || userRole !== 'coach') return;
    
    let pid = null, sx = 0, sy = 0, ox = 0, oy = 0;
    
    const down = e => {
        if (!isAuthorized || userRole !== 'coach') return;
        
        pid = e.pointerId; 
        playerEl.setPointerCapture(pid); 
        e.preventDefault();
        sx = e.clientX; 
        sy = e.clientY;
        ox = parseFloat(playerEl.style.left) || 0;
        oy = parseFloat(playerEl.style.top) || 0;

        // Seleccionar jugador
        clearPlayerSelection();
        playerEl.classList.add('selected');
        selectedPlayers.add(playerEl);

        const move = ev => {
            if (ev.pointerId !== pid || !isAuthorized) return;
            ev.preventDefault();
            const {dx, dy} = deltaToBoard(ev.clientX - sx, ev.clientY - sy);
            const nx = clamp(ox + dx, 0, WIDTH);
            const ny = clamp(oy + dy, 0, HEIGHT);
            playerEl.style.left = nx + 'px';
            playerEl.style.top = ny + 'px';
        };

        const up = ev => {
            if (ev.pointerId !== pid) return;
            try { playerEl.releasePointerCapture(pid); } catch {}
            document.removeEventListener('pointermove', move);
            document.removeEventListener('pointerup', up);
            onDrop && onDrop(false);
        };

        document.addEventListener('pointermove', move, {passive: false});
        document.addEventListener('pointerup', up, {passive: false});
    };

    playerEl.addEventListener('pointerdown', down, {passive: false});
    playerEl.ondragstart = () => false;
}

function enableDragBall(onDrop) {
    if (!isAuthorized || userRole !== 'coach') return;
    
    let pid = null, sx = 0, sy = 0, ox = 0, oy = 0;
    
    const down = e => {
        if (!isAuthorized || userRole !== 'coach') return;
        
        pid = e.pointerId; 
        ball.setPointerCapture(pid); 
        e.preventDefault();
        sx = e.clientX; 
        sy = e.clientY;
        ox = currentBallPos.x;
        oy = currentBallPos.y;

        // Limpiar selecci√≥n al tocar el bal√≥n
        clearPlayerSelection();

        const move = ev => {
            if (ev.pointerId !== pid || !isAuthorized) return;
            ev.preventDefault();
            const {dx, dy} = deltaToBoard(ev.clientX - sx, ev.clientY - sy);
            const nx = clamp(ox + dx, 0, WIDTH);
            const ny = clamp(oy + dy, 0, HEIGHT);
            placeBall(nx, ny);
        };

        const up = ev => {
            if (ev.pointerId !== pid) return;
            try { ball.releasePointerCapture(pid); } catch {}
            document.removeEventListener('pointermove', move);
            document.removeEventListener('pointerup', up);
            onDrop && onDrop();
        };

        document.addEventListener('pointermove', move, {passive: false});
        document.addEventListener('pointerup', up, {passive: false});
    };

    if (ball) ball.addEventListener('pointerdown', down, {passive: false});
    if (ball) ball.ondragstart = () => false;
}

function enableSelectionBox() {
    if (!isAuthorized || userRole !== 'coach') return;
    
    let pid = null, startBoard = null;
    
    const down = e => {
        if (!isAuthorized || userRole !== 'coach') return;
        if (e.target.closest('.player') || e.target.closest('#ball')) return;
        
        pid = e.pointerId; 
        board.setPointerCapture(pid);
        e.preventDefault();
        startBoard = clientToBoard(e);
        
        if (selectionBox) {
            selectionBox.style.left = startBoard.x + 'px';
            selectionBox.style.top = startBoard.y + 'px';
            selectionBox.style.width = '0';
            selectionBox.style.height = '0';
            selectionBox.style.display = 'block';
        }

        const move = ev => {
            if (ev.pointerId !== pid || !isAuthorized) return;
            ev.preventDefault();
            const currentBoard = clientToBoard(ev);
            const left = Math.min(startBoard.x, currentBoard.x);
            const top = Math.min(startBoard.y, currentBoard.y);
            const width = Math.abs(currentBoard.x - startBoard.x);
            const height = Math.abs(currentBoard.y - startBoard.y);
            
            if (selectionBox) {
                selectionBox.style.left = left + 'px';
                selectionBox.style.top = top + 'px';
                selectionBox.style.width = width + 'px';
                selectionBox.style.height = height + 'px';
            }
        };

        const up = ev => {
            if (ev.pointerId !== pid) return;
            try { board.releasePointerCapture(pid); } catch {}
            document.removeEventListener('pointermove', move);
            document.removeEventListener('pointerup', up);
            if (selectionBox) selectionBox.style.display = 'none';
        };

        document.addEventListener('pointermove', move, {passive: false});
        document.addEventListener('pointerup', up, {passive: false});
    };

    if (board) board.addEventListener('pointerdown', down);
}

function initDrawingTools() {
    if (!board) return;
    
    let drawingArrow = false, startPt = null, drawingStroke = false, currentStroke = null;
    let tool = 'arrows'; // herramienta por defecto
    
    // Configurar eventos de herramientas
    if (toolArrows) {
        toolArrows.addEventListener('click', () => {
            tool = 'arrows';
            setToolActive(toolArrows, [toolPen, toolText]);
        });
    }
    
    if (toolPen) {
        toolPen.addEventListener('click', () => {
            tool = 'pen';
            setToolActive(toolPen, [toolArrows, toolText]);
        });
    }
    
    if (toolText) {
        toolText.addEventListener('click', () => {
            tool = 'text';
            setToolActive(toolText, [toolArrows, toolPen]);
        });
    }
    
    // Evento de dibujo en el tablero
    board.addEventListener('pointerdown', e => {
        if (!isAuthorized || userRole !== 'coach') return;
        if (e.target.closest('.player') || e.target.closest('#ball')) return;
        
        let p = clientToBoard(e);
        
        const currentStrokeColor = strokeColor ? strokeColor.value : '#ffd400';
        const currentStrokeWidth = strokeWidth ? parseInt(strokeWidth.value, 10) : 5;

        if (tool === 'arrows') {
            drawingArrow = true; 
            startPt = {x: p.x, y: p.y}; 
        } else if (tool === 'pen') {
            drawingStroke = true;
            currentStroke = { 
                points: [`${p.x},${p.y}`], 
                color: currentStrokeColor, 
                width: currentStrokeWidth, 
                dashed: dashed ? dashed.checked : false 
            };
            strokes.push(currentStroke); 
            renderDraw();
        } else if (tool === 'text') {
            const text = prompt("Ingresa el texto para la nota:");
            if (text && text.trim()) {
                notes.push({ 
                    x: p.x, 
                    y: p.y, 
                    text: text.trim().substring(0, 30), 
                    color: currentStrokeColor 
                });
                renderDraw();
            }
            // Volver a flechas despu√©s de agregar texto
            tool = 'arrows';
            setToolActive(toolArrows, [toolPen, toolText]);
        }
    }, {passive: false});

    board.addEventListener('pointermove', e => {
        if (!isAuthorized || !drawingStroke || !currentStroke) return;
        
        let p = clientToBoard(e);
        const last = currentStroke.points[currentStroke.points.length - 1];
        const [lx, ly] = last.split(',').map(Number);
        
        if (Math.abs(p.x - lx) + Math.abs(p.y - ly) > 0.5) {
            currentStroke.points.push(`${p.x},${p.y}`); 
            renderDraw();
        }
    }, {passive: false});

    board.addEventListener('pointerup', e => {
        if (!isAuthorized) return;
        
        let p = clientToBoard(e);
        const currentStrokeColor = strokeColor ? strokeColor.value : '#ffd400';
        const currentStrokeWidth = strokeWidth ? parseInt(strokeWidth.value, 10) : 5;

        if (drawingArrow && startPt) {
            arrows.push({ 
                x1: startPt.x, 
                y1: startPt.y, 
                x2: p.x, 
                y2: p.y, 
                color: currentStrokeColor, 
                width: currentStrokeWidth, 
                dashed: dashed ? dashed.checked : false 
            });
            drawingArrow = false; 
            startPt = null; 
            renderDraw();
        } else if (drawingStroke && currentStroke) {
            drawingStroke = false; 
            renderDraw();
        }
    }, {passive: false});
    
    // Eventos para botones de dibujo
    if (btnUndo) {
        btnUndo.addEventListener('click', () => {
            if (!isAuthorized || userRole !== 'coach') return;
            
            if (tool === 'arrows') {
                arrows.pop();
            } else if (tool === 'pen') {
                strokes.pop();
            } else if (tool === 'text') {
                notes.pop();
            }
            renderDraw();
        });
    }
    
    if (btnClear) {
        btnClear.addEventListener('click', () => {
            if (!isAuthorized || userRole !== 'coach') return;
            
            if (confirm('¬øBorrar todos los dibujos?')) {
                arrows = [];
                strokes = [];
                notes = [];
                renderDraw();
            }
        });
    }
}

function setToolActive(activeTool, otherTools) {
    activeTool.classList.add('active');
    otherTools.forEach(tool => tool.classList.remove('active'));
}

function clearPlayerSelection() {
    selectedPlayers.forEach(el => el.classList.remove('selected'));
    selectedPlayers.clear();
}

// Funci√≥n para renderizar dibujos en el SVG
function renderDraw() {
    if (!draw) return;
    
    // Limpiar dibujos anteriores (mantener las l√≠neas del campo)
    const existingElements = draw.querySelectorAll('line, polyline, text');
    existingElements.forEach(el => el.remove());
    
    // Renderizar flechas
    arrows.forEach(arrow => {
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', arrow.x1);
        line.setAttribute('y1', arrow.y1);
        line.setAttribute('x2', arrow.x2);
        line.setAttribute('y2', arrow.y2);
        line.setAttribute('stroke', arrow.color || '#ffd400');
        line.setAttribute('stroke-width', arrow.width || 5);
        line.setAttribute('stroke-linecap', 'round');
        if (arrow.dashed) {
            line.setAttribute('stroke-dasharray', '8 8');
        }
        draw.appendChild(line);
    });
    
    // Renderizar trazos
    strokes.forEach(stroke => {
        if (stroke.points.length < 2) return;
        
        const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
        polyline.setAttribute('points', stroke.points.join(' '));
        polyline.setAttribute('fill', 'none');
        polyline.setAttribute('stroke', stroke.color || '#ffd400');
        polyline.setAttribute('stroke-width', stroke.width || 5);
        polyline.setAttribute('stroke-linecap', 'round');
        polyline.setAttribute('stroke-linejoin', 'round');
        if (stroke.dashed) {
            polyline.setAttribute('stroke-dasharray', '8 8');
        }
        draw.appendChild(polyline);
    });
    
    // Renderizar notas de texto
    notes.forEach(note => {
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', note.x);
        text.setAttribute('y', note.y);
        text.setAttribute('fill', note.color || '#ffffff');
        text.setAttribute('font-size', '18');
        text.setAttribute('font-weight', 'bold');
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('dominant-baseline', 'middle');
        text.textContent = note.text;
        draw.appendChild(text);
    });
}

// Funci√≥n para re-inicializar interacciones
function reInitializePlayerInteractions() {
    if (!playersLayer || !ball) return;
    
    // Habilitar arrastre de jugadores
    [...playersLayer.children].forEach(el => {
        enableDragPlayer(el, () => { 
            if (autoRec && autoRec.checked) recordFrame(); 
        });
    });
    
    // Habilitar arrastre de bal√≥n
    enableDragBall(() => { 
        if (autoRec && autoRec.checked) recordFrame(); 
    });
    
    // Habilitar selecci√≥n masiva
    enableSelectionBox();
    
    // Habilitar herramientas de dibujo
    initDrawingTools();
}

// Funci√≥n para la l√≠nea de pase
function showPassPreview(x1, y1, x2, y2) {
    if (!draw) return;
    let line = draw.querySelector('#passPreview');
    if (!line) {
        line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('id', 'passPreview');
        line.setAttribute('stroke', '#fff');
        line.setAttribute('stroke-width', '3');
        line.setAttribute('stroke-dasharray', '10 8');
        draw.appendChild(line);
    }
    line.setAttribute('x1', x1);
    line.setAttribute('y1', y1);
    line.setAttribute('x2', x2);
    line.setAttribute('y2', y2);
}

function hidePassPreview() {
    const l = draw.querySelector('#passPreview');
    if (l) l.remove();
}

// Funci√≥n para la grilla
function renderGrid() {
    if (!gridSvg) return;
    gridSvg.innerHTML = '';
    if (!showGrid.checked) {
        gridSvg.classList.remove('on');
        return;
    }
    gridSvg.classList.add('on');
    
    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    
    // L√≠neas verticales
    for (let x = GRID; x < WIDTH; x += GRID) {
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', x);
        line.setAttribute('y1', '0');
        line.setAttribute('x2', x);
        line.setAttribute('y2', HEIGHT);
        line.setAttribute('stroke', 'rgba(255,255,255,0.1)');
        line.setAttribute('stroke-width', '1');
        g.appendChild(line);
    }
    
    // L√≠neas horizontales
    for (let y = GRID; y < HEIGHT; y += GRID) {
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', '0');
        line.setAttribute('y1', y);
        line.setAttribute('x2', WIDTH);
        line.setAttribute('y2', y);
        line.setAttribute('stroke', 'rgba(255,255,255,0.1)');
        line.setAttribute('stroke-width', '1');
        g.appendChild(line);
    }
    
    gridSvg.appendChild(g);
}

// Actualizar la funci√≥n initBoardApp para incluir las interacciones
// BUSC√Å esta l√≠nea en initBoardApp y AGREGALO:
function initBoardApp(){
    console.log("Inicializando aplicaci√≥n...");
    
    // Crear jugadores y bal√≥n
    createPlayers();
    placeBall();
    
    // Timeline inicial
    if (!timeline.length) { recordFrame(); }
    updateScrub();

    // Configurar Firebase Auth State Listener
    if (window.firebaseOnAuthStateChanged) {
        // Primero verificar el estado actual inmediatamente
        const currentAuthUser = window.firebaseAuth.currentUser;
        if (currentAuthUser) {
            console.log('‚úÖ Usuario ya autenticado al cargar:', currentAuthUser.email);
            currentUser = currentAuthUser;
            isAuthorized = true;
            (async () => {
                await determineUserRole();
                refreshPlayList();
                updateAuthUI();
                
                // INICIALIZAR INTERACCIONES SI ES COACH
                if (userRole === 'coach') {
                    reInitializePlayerInteractions();
                }
            })();
        }

        // Luego configurar el listener para cambios futuros
        window.firebaseOnAuthStateChanged(window.firebaseAuth, async (user) => {
            console.log('üîÑ Auth state changed:', user ? user.email : 'No user');
            
            if (user) {
                currentUser = user;
                isAuthorized = true;
                console.log('‚úÖ Usuario autenticado via listener:', user.email);
                
                await determineUserRole();
                refreshPlayList();
                
                // INICIALIZAR INTERACCIONES SI ES COACH
                if (userRole === 'coach') {
                    reInitializePlayerInteractions();
                }
            } else {
                currentUser = null;
                isAuthorized = false;
                userRole = 'spectator';
                currentCoachId = null;
                console.log('üö™ Usuario cerr√≥ sesi√≥n');
                
                if (unsubscribePlays) {
                    unsubscribePlays();
                    unsubscribePlays = null;
                }
            }
            updateAuthUI();
        });
    } else {
        console.log('‚ö†Ô∏è Firebase Auth no disponible - Modo local');
    }

    // INICIALIZAR INTERACCIONES B√ÅSICAS
    reInitializePlayerInteractions();

    // UI inicial
    if (showGrid) {
        showGrid.addEventListener('change', renderGrid);
        showGrid.checked = false;
    }
  // Agreg√° esto en la secci√≥n de event listeners:
if (showGrid) {
    showGrid.addEventListener('change', renderGrid);
}

if (btnRecord) {
    btnRecord.addEventListener('click', recordFrame);
}

if (btnPlayPause) {
    btnPlayPause.addEventListener('click', () => {
        if (!playing) {
            playing = true;
            btnPlayPause.textContent = 'Pausa';
            // Aqu√≠ ir√≠a la l√≥gica de reproducci√≥n
        } else {
            playing = false;
            btnPlayPause.textContent = 'Reproducir';
        }
    });
}

if (btnStop) {
    btnStop.addEventListener('click', () => {
        playing = false;
        btnPlayPause.textContent = 'Reproducir';
        gotoFrame(0);
    });
}

if (btnReset) {
    btnReset.addEventListener('click', () => {
        if (confirm('¬øReiniciar tablero? Se perder√°n los cambios no guardados.')) {
            createPlayers();
            placeBall();
            arrows = [];
            strokes = [];
            notes = [];
            timeline = [];
            recordFrame();
            renderDraw();
            showStatus('Tablero reiniciado', 'var(--accent)');
        }
    });
}
    renderGrid();
    renderDraw();
    fitBoard();
    
    // Forzar rec√°lculo del layout
    setTimeout(fitBoard, 50);
    
    showStatus('Sistema Bologna Rugby Club cargado', 'var(--accent2)');
}
    
    // Eventos de men√∫ m√≥vil
    if (btnMenuOpen) btnMenuOpen.addEventListener('click', openMobileMenu);
    if (btnCloseMenu) btnCloseMenu.addEventListener('click', closeMobileMenu);
    if (menuOverlay) menuOverlay.addEventListener('click', closeMobileMenu);
    
    // Eventos de orientaci√≥n
    if (btnLandscape) btnLandscape.addEventListener('click', ()=>{ 
        forcePortrait=false; 
        setSegActive(btnLandscape,btnPortrait); 
        fitBoard(); 
        closeMobileMenu(); 
    });
    
    if (btnPortrait) btnPortrait.addEventListener('click', ()=>{ 
        forcePortrait=true; 
        setSegActive(btnPortrait,btnLandscape); 
        fitBoard(); 
        closeMobileMenu(); 
    });

    // Eventos de ventana
    window.addEventListener('resize', fitBoard);
    window.addEventListener('orientationchange', fitBoard);
    
    // Inicializar aplicaci√≥n
    initBoardApp();
});

// Exponer funciones globalmente
window.initBoardApp = initBoardApp;
window.fitBoard = fitBoard;
</script>
</body>
</html>
